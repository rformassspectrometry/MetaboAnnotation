<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Annotation of MS-based Metabolomics Data • MetaboAnnotation</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Annotation of MS-based Metabolomics Data">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">MetaboAnnotation</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.13.2</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/MetaboAnnotation.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/RforMassSpectrometry/MetaboAnnotation/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Annotation of MS-based Metabolomics Data</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/RforMassSpectrometry/MetaboAnnotation/blob/main/vignettes/MetaboAnnotation.Rmd" class="external-link"><code>vignettes/MetaboAnnotation.Rmd</code></a></small>
      <div class="d-none name"><code>MetaboAnnotation.Rmd</code></div>
    </div>

    
    
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function() {
  document.querySelector("h1").className = "title";
});
</script><script type="text/javascript">
document.addEventListener("DOMContentLoaded", function() {
  var links = document.links;  
  for (var i = 0, linksLength = links.length; i < linksLength; i++)
    if (links[i].hostname != window.location.hostname)
      links[i].target = '_blank';
});
</script><p><strong>Package</strong>: <em><a href="https://bioconductor.org/packages/3.22/MetaboAnnotation" class="external-link">MetaboAnnotation</a></em><br><strong>Authors</strong>: Michael Witting [aut] (ORCID: <a href="https://orcid.org/0000-0002-1462-4426" class="external-link uri">https://orcid.org/0000-0002-1462-4426</a>), Johannes Rainer
[aut, cre] (ORCID: <a href="https://orcid.org/0000-0002-6977-7147" class="external-link uri">https://orcid.org/0000-0002-6977-7147</a>), Andrea Vicini
[aut] (ORCID: <a href="https://orcid.org/0000-0001-9438-6909" class="external-link uri">https://orcid.org/0000-0001-9438-6909</a>), Carolin Huber
[aut] (ORCID: <a href="https://orcid.org/0000-0002-9355-8948" class="external-link uri">https://orcid.org/0000-0002-9355-8948</a>), Philippine
Louail [aut] (ORCID: <a href="https://orcid.org/0009-0007-5429-6846" class="external-link uri">https://orcid.org/0009-0007-5429-6846</a>), Nir Shachaf
[ctb]<br><strong>Compiled</strong>: Tue Oct 14 08:02:04 2025</p>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The <em><a href="https://bioconductor.org/packages/3.22/MetaboAnnotation" class="external-link">MetaboAnnotation</a></em>
package defines high-level user functionality to support and facilitate
annotation of MS-based metabolomics data <span class="citation">(Rainer
et al. 2022)</span>.</p>
</div>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<p>The package can be installed with the <em>BiocManager</em> package.
To install <code>BiocManager</code> use
<code>install.packages("BiocManager")</code> and, after that,
<code>BiocManager::install("MetaboAnnotation")</code> to install this
package.</p>
</div>
<div class="section level2">
<h2 id="general-description">General description<a class="anchor" aria-label="anchor" href="#general-description"></a>
</h2>
<p><em>MetaboAnnotation</em> provides a set of <em>matching</em>
functions that allow comparison (and matching) between <em>query</em>
and <em>target</em> entities. These entities can be chemical formulas,
numeric values (e.g. m/z or retention times) or fragment spectra. The
available matching functions are:</p>
<ul>
<li>
<code><a href="../reference/matchFormula.html">matchFormula()</a></code>: to match chemical formulas.</li>
<li>
<code><a href="../reference/matchSpectra.html">matchSpectra()</a></code>: to match fragment spectra.</li>
<li>
<code><a href="../reference/matchValues.html">matchValues()</a></code> (formerly <code><a href="../reference/matchValues.html">matchMz()</a></code>): to
match numerical values (m/z, masses, retention times etc).</li>
</ul>
<p>For each of these matching functions <em>parameter</em> objects are
available that allow different types or matching algorithms. Refer to
the help pages for a detailed listing of these
(e.g. <code><a href="../reference/matchFormula.html">?matchFormula</a></code>, <code><a href="../reference/matchSpectra.html">?matchSpectra</a></code> or
<code><a href="../reference/matchValues.html">?matchValues</a></code>). As a result, a <code>Matched</code> (or
<code>MatchedSpectra</code>) object is returned which streamlines and
simplifies handling of the potential one-to-many (or one-to-none)
matching.</p>
</div>
<div class="section level2">
<h2 id="example-use-cases">Example use cases<a class="anchor" aria-label="anchor" href="#example-use-cases"></a>
</h2>
<p>The following sections illustrate example use cases of the
functionality provided by the <em>MetaboAnnotation</em> package.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/MetaboAnnotation" class="external-link">MetaboAnnotation</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="matching-of-mz-values">Matching of m/z values<a class="anchor" aria-label="anchor" href="#matching-of-mz-values"></a>
</h3>
<p>In this section a simple matching of feature m/z values against
theoretical m/z values is performed. This is the lowest level of
confidence in metabolite annotation. However, it gives ideas about
potential metabolites that can be analyzed in further downstream
experiments and analyses.</p>
<p>The following example loads the feature table from a lipidomics
experiments and matches the measured m/z values against reference masses
from LipidMaps. Below we use a <code>data.frame</code> as
<em>reference</em> database, but a <code>CompDb</code> compound database
instance (as created by the <em><a href="https://bioconductor.org/packages/3.22/CompoundDb" class="external-link">CompoundDb</a></em>
package) would also be supported.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ms1_features</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"MS1_example.txt"</span>,</span>
<span>                                       package <span class="op">=</span> <span class="st">"MetaboAnnotation"</span><span class="op">)</span>,</span>
<span>                           header <span class="op">=</span> <span class="cn">TRUE</span>, sep <span class="op">=</span> <span class="st">"\t"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">ms1_features</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##     feature_id       mz    rtime</span></span>
<span><span class="co">## 1 Cluster_0001 102.1281 1.560147</span></span>
<span><span class="co">## 2 Cluster_0002 102.1279 2.153590</span></span>
<span><span class="co">## 3 Cluster_0003 102.1281 2.925570</span></span>
<span><span class="co">## 4 Cluster_0004 102.1281 3.419617</span></span>
<span><span class="co">## 5 Cluster_0005 102.1270 5.801039</span></span>
<span><span class="co">## 6 Cluster_0006 102.1230 8.137535</span></span></code></pre>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">target_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"LipidMaps_CompDB.txt"</span>,</span>
<span>                                    package <span class="op">=</span> <span class="st">"MetaboAnnotation"</span><span class="op">)</span>,</span>
<span>                        header <span class="op">=</span> <span class="cn">TRUE</span>, sep <span class="op">=</span> <span class="st">"\t"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">target_df</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   headgroup        name exactmass    formula chain_type</span></span>
<span><span class="co">## 1       NAE  NAE 20:4;O  363.2773  C22H37NO3       even</span></span>
<span><span class="co">## 2       NAT  NAT 20:4;O  427.2392 C22H37NO5S       even</span></span>
<span><span class="co">## 3       NAE NAE 20:3;O2  381.2879  C22H39NO4       even</span></span>
<span><span class="co">## 4       NAE    NAE 20:4  347.2824  C22H37NO2       even</span></span>
<span><span class="co">## 5       NAE    NAE 18:2  323.2824  C20H37NO2       even</span></span>
<span><span class="co">## 6       NAE    NAE 18:3  321.2668  C20H35NO2       even</span></span></code></pre>
<p>For reference (target) compounds we have only the mass available. We
need to convert this mass to m/z values in order to match the m/z values
from the features (i.e. the query m/z values) against them. For this we
need to define the <em>most likely</em> ions/adducts that would be
generated from the compounds based on the ionization used in the
experiment. We assume the most abundant adducts from the compounds being
<code>"[M+H]+"</code> and <code>"[M+Na]+</code>. We next perform the
matching with the <code><a href="../reference/matchValues.html">matchValues()</a></code> function providing the
query and target data as well as a parameter object (in our case a
<code>Mass2MzParam</code>) with the settings for the matching. With the
<code>Mass2MzParam</code>, the mass or target compounds get first
converted to m/z values, based on the defined adducts, and these are
then matched against the query m/z values (i.e. the m/z values for the
features). To get a full list of supported adducts the
<code>MetaboCoreUtils::adductNames(polarity = "positive")</code> or
<code>MetaboCoreUtils::adductNames(polarity = "negative")</code> can be
used). Note also, to keep the runtime of this vignette short, we match
only the first 100 features.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">parm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/matchValues.html">Mass2MzParam</a></span><span class="op">(</span>adducts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"[M+H]+"</span>, <span class="st">"[M+Na]+"</span><span class="op">)</span>,</span>
<span>                           tolerance <span class="op">=</span> <span class="fl">0.005</span>, ppm <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="va">matched_features</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/matchValues.html">matchValues</a></span><span class="op">(</span><span class="va">ms1_features</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">100</span>, <span class="op">]</span>, <span class="va">target_df</span>, <span class="va">parm</span><span class="op">)</span></span>
<span><span class="va">matched_features</span></span></code></pre></div>
<pre><code><span><span class="co">## Object of class Matched </span></span>
<span><span class="co">## Total number of matches: 55 </span></span>
<span><span class="co">## Number of query objects: 100 (55 matched)</span></span>
<span><span class="co">## Number of target objects: 57599 (1 matched)</span></span></code></pre>
<p>From the tested 100 features 55 were matched against at least one
target compound (all matches are against a single compound). The result
object (of type <code>Matched</code>) contains the full query data frame
and target data frames as well as the matching information. We can
access the original query data with <code>query()</code> and the
original target data with <code><a href="../reference/Matched.html">target()</a></code> function:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu">query</span><span class="op">(</span><span class="va">matched_features</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##     feature_id       mz    rtime</span></span>
<span><span class="co">## 1 Cluster_0001 102.1281 1.560147</span></span>
<span><span class="co">## 2 Cluster_0002 102.1279 2.153590</span></span>
<span><span class="co">## 3 Cluster_0003 102.1281 2.925570</span></span>
<span><span class="co">## 4 Cluster_0004 102.1281 3.419617</span></span>
<span><span class="co">## 5 Cluster_0005 102.1270 5.801039</span></span>
<span><span class="co">## 6 Cluster_0006 102.1230 8.137535</span></span></code></pre>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="../reference/Matched.html">target</a></span><span class="op">(</span><span class="va">matched_features</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   headgroup        name exactmass    formula chain_type</span></span>
<span><span class="co">## 1       NAE  NAE 20:4;O  363.2773  C22H37NO3       even</span></span>
<span><span class="co">## 2       NAT  NAT 20:4;O  427.2392 C22H37NO5S       even</span></span>
<span><span class="co">## 3       NAE NAE 20:3;O2  381.2879  C22H39NO4       even</span></span>
<span><span class="co">## 4       NAE    NAE 20:4  347.2824  C22H37NO2       even</span></span>
<span><span class="co">## 5       NAE    NAE 18:2  323.2824  C20H37NO2       even</span></span>
<span><span class="co">## 6       NAE    NAE 18:3  321.2668  C20H35NO2       even</span></span></code></pre>
<p>Functions <code><a href="../reference/Matched.html">whichQuery()</a></code> and <code><a href="../reference/Matched.html">whichTarget()</a></code>
can be used to identify the rows in the query and target data that could
be matched:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/Matched.html">whichQuery</a></span><span class="op">(</span><span class="va">matched_features</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1]  46  47  48  49  50  51  52  53  54  55  56  57  58  59  60  61  62  63  64</span></span>
<span><span class="co">## [20]  65  66  67  68  69  70  71  72  73  74  75  76  77  78  79  80  81  82  83</span></span>
<span><span class="co">## [39]  84  85  86  87  88  89  90  91  92  93  94  95  96  97  98  99 100</span></span></code></pre>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/Matched.html">whichTarget</a></span><span class="op">(</span><span class="va">matched_features</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 3149</span></span></code></pre>
<p>The <code>colnames</code> function can be used to evaluate which
variables/columns are available in the <code>Matched</code> object.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">matched_features</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] "feature_id"        "mz"                "rtime"            </span></span>
<span><span class="co">##  [4] "target_headgroup"  "target_name"       "target_exactmass" </span></span>
<span><span class="co">##  [7] "target_formula"    "target_chain_type" "adduct"           </span></span>
<span><span class="co">## [10] "score"             "ppm_error"</span></span></code></pre>
<p>These are all columns from the <code>query</code>, all columns from
the <code>target</code> (the prefix <code>"target_"</code> is added to
the original column names in <code>target</code>) and information on the
matching result (in this case columns <code>"adduct"</code>,
<code>"score"</code> and <code>"ppm_error"</code>).</p>
<p>We can extract the full matching table with
<code><a href="../reference/Matched.html">matchedData()</a></code>. This returns a <code>DataFrame</code> with
all rows in <em>query</em> the corresponding matches in <em>target</em>
along with the matching adduct (column <code>"adduct"</code>) and the
difference in m/z (column <code>"score"</code> for absolute differences
and <code>"ppm_error"</code> for the m/z relative differences). Note
that if a row in <em>query</em> matches multiple elements in
<em>target</em>, this row will be duplicated in the
<code>DataFrame</code> returned by <code><a href="../reference/Matched.html">matchedData()</a></code>. For rows
that can not be matched <code>NA</code> values are reported.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/Matched.html">matchedData</a></span><span class="op">(</span><span class="va">matched_features</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## DataFrame with 100 rows and 11 columns</span></span>
<span><span class="co">##        feature_id        mz     rtime target_headgroup target_name</span></span>
<span><span class="co">##       &lt;character&gt; &lt;numeric&gt; &lt;numeric&gt;      &lt;character&gt; &lt;character&gt;</span></span>
<span><span class="co">## 1   Cluster_00...   102.128   1.56015               NA          NA</span></span>
<span><span class="co">## 2   Cluster_00...   102.128   2.15359               NA          NA</span></span>
<span><span class="co">## 3   Cluster_00...   102.128   2.92557               NA          NA</span></span>
<span><span class="co">## 4   Cluster_00...   102.128   3.41962               NA          NA</span></span>
<span><span class="co">## 5   Cluster_00...   102.127   5.80104               NA          NA</span></span>
<span><span class="co">## ...           ...       ...       ...              ...         ...</span></span>
<span><span class="co">## 96  Cluster_00...   201.113   11.2722               FA  FA 10:2;O2</span></span>
<span><span class="co">## 97  Cluster_00...   201.113   11.4081               FA  FA 10:2;O2</span></span>
<span><span class="co">## 98  Cluster_00...   201.113   11.4760               FA  FA 10:2;O2</span></span>
<span><span class="co">## 99  Cluster_00...   201.114   11.5652               FA  FA 10:2;O2</span></span>
<span><span class="co">## 100 Cluster_01...   201.114   11.7752               FA  FA 10:2;O2</span></span>
<span><span class="co">##     target_exactmass target_formula target_chain_type      adduct     score</span></span>
<span><span class="co">##            &lt;numeric&gt;    &lt;character&gt;       &lt;character&gt; &lt;character&gt; &lt;numeric&gt;</span></span>
<span><span class="co">## 1                 NA             NA                NA          NA        NA</span></span>
<span><span class="co">## 2                 NA             NA                NA          NA        NA</span></span>
<span><span class="co">## 3                 NA             NA                NA          NA        NA</span></span>
<span><span class="co">## 4                 NA             NA                NA          NA        NA</span></span>
<span><span class="co">## 5                 NA             NA                NA          NA        NA</span></span>
<span><span class="co">## ...              ...            ...               ...         ...       ...</span></span>
<span><span class="co">## 96           200.105       C10H16O4              even      [M+H]+ 0.0007312</span></span>
<span><span class="co">## 97           200.105       C10H16O4              even      [M+H]+ 0.0005444</span></span>
<span><span class="co">## 98           200.105       C10H16O4              even      [M+H]+ 0.0005328</span></span>
<span><span class="co">## 99           200.105       C10H16O4              even      [M+H]+ 0.0014619</span></span>
<span><span class="co">## 100          200.105       C10H16O4              even      [M+H]+ 0.0020342</span></span>
<span><span class="co">##     ppm_error</span></span>
<span><span class="co">##     &lt;numeric&gt;</span></span>
<span><span class="co">## 1          NA</span></span>
<span><span class="co">## 2          NA</span></span>
<span><span class="co">## 3          NA</span></span>
<span><span class="co">## 4          NA</span></span>
<span><span class="co">## 5          NA</span></span>
<span><span class="co">## ...       ...</span></span>
<span><span class="co">## 96    3.63578</span></span>
<span><span class="co">## 97    2.70695</span></span>
<span><span class="co">## 98    2.64927</span></span>
<span><span class="co">## 99    7.26908</span></span>
<span><span class="co">## 100  10.11476</span></span></code></pre>
<p>Individual columns can be simply extracted with the <code>$</code>
operator:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">matched_features</span><span class="op">$</span><span class="va">target_name</span></span></code></pre></div>
<pre><code><span><span class="co">##   [1] NA           NA           NA           NA           NA          </span></span>
<span><span class="co">##   [6] NA           NA           NA           NA           NA          </span></span>
<span><span class="co">##  [11] NA           NA           NA           NA           NA          </span></span>
<span><span class="co">##  [16] NA           NA           NA           NA           NA          </span></span>
<span><span class="co">##  [21] NA           NA           NA           NA           NA          </span></span>
<span><span class="co">##  [26] NA           NA           NA           NA           NA          </span></span>
<span><span class="co">##  [31] NA           NA           NA           NA           NA          </span></span>
<span><span class="co">##  [36] NA           NA           NA           NA           NA          </span></span>
<span><span class="co">##  [41] NA           NA           NA           NA           NA          </span></span>
<span><span class="co">##  [46] "FA 10:2;O2" "FA 10:2;O2" "FA 10:2;O2" "FA 10:2;O2" "FA 10:2;O2"</span></span>
<span><span class="co">##  [51] "FA 10:2;O2" "FA 10:2;O2" "FA 10:2;O2" "FA 10:2;O2" "FA 10:2;O2"</span></span>
<span><span class="co">##  [56] "FA 10:2;O2" "FA 10:2;O2" "FA 10:2;O2" "FA 10:2;O2" "FA 10:2;O2"</span></span>
<span><span class="co">##  [61] "FA 10:2;O2" "FA 10:2;O2" "FA 10:2;O2" "FA 10:2;O2" "FA 10:2;O2"</span></span>
<span><span class="co">##  [66] "FA 10:2;O2" "FA 10:2;O2" "FA 10:2;O2" "FA 10:2;O2" "FA 10:2;O2"</span></span>
<span><span class="co">##  [71] "FA 10:2;O2" "FA 10:2;O2" "FA 10:2;O2" "FA 10:2;O2" "FA 10:2;O2"</span></span>
<span><span class="co">##  [76] "FA 10:2;O2" "FA 10:2;O2" "FA 10:2;O2" "FA 10:2;O2" "FA 10:2;O2"</span></span>
<span><span class="co">##  [81] "FA 10:2;O2" "FA 10:2;O2" "FA 10:2;O2" "FA 10:2;O2" "FA 10:2;O2"</span></span>
<span><span class="co">##  [86] "FA 10:2;O2" "FA 10:2;O2" "FA 10:2;O2" "FA 10:2;O2" "FA 10:2;O2"</span></span>
<span><span class="co">##  [91] "FA 10:2;O2" "FA 10:2;O2" "FA 10:2;O2" "FA 10:2;O2" "FA 10:2;O2"</span></span>
<span><span class="co">##  [96] "FA 10:2;O2" "FA 10:2;O2" "FA 10:2;O2" "FA 10:2;O2" "FA 10:2;O2"</span></span></code></pre>
<p><code>NA</code> is reported for query entries for which no match was
found. See also the help page for <code><a href="../reference/Matched.html">?Matched</a></code> for more details
and information. In addition to the matching of query m/z against target
exact masses as described above it would also be possible to match
directly query m/z against target m/z values by using the
<code>MzParam</code> instead of the <code>Mass2MzParam</code>.</p>
</div>
<div class="section level3">
<h3 id="matching-of-mz-and-retention-time-values">Matching of m/z and retention time values<a class="anchor" aria-label="anchor" href="#matching-of-mz-and-retention-time-values"></a>
</h3>
<p>If expected retention time values were available for the target
compounds, an annotation with higher confidence could be performed with
<code><a href="../reference/matchValues.html">matchValues()</a></code> and a <code>Mass2MzRtParam</code> parameter
object. To illustrate this we randomly assign retention times from query
features to the target compounds adding also 2 seconds difference. In a
real use case the target <code>data.frame</code> would contain masses
(or m/z values) for standards along with the retention times when ions
of these standards were measured on the same LC-MS setup from which the
query data derives.</p>
<p>Below we subset our data table with the MS1 features to the first 100
rows (to keep the runtime of the vignette short).</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ms1_subset</span> <span class="op">&lt;-</span> <span class="va">ms1_features</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">100</span>, <span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">ms1_subset</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##     feature_id       mz    rtime</span></span>
<span><span class="co">## 1 Cluster_0001 102.1281 1.560147</span></span>
<span><span class="co">## 2 Cluster_0002 102.1279 2.153590</span></span>
<span><span class="co">## 3 Cluster_0003 102.1281 2.925570</span></span>
<span><span class="co">## 4 Cluster_0004 102.1281 3.419617</span></span>
<span><span class="co">## 5 Cluster_0005 102.1270 5.801039</span></span>
<span><span class="co">## 6 Cluster_0006 102.1230 8.137535</span></span></code></pre>
<p>The table contains thus retention times of the features in a column
named <code>"rtime"</code>.</p>
<p>Next we randomly assign retention times of the features to compounds
in our target data adding a deviation of 2 seconds. As described above,
in a real use case retention times are supposed to be determined by
measuring the compounds with the same LC-MS setup.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">target_df</span><span class="op">$</span><span class="va">rtime</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">ms1_subset</span><span class="op">$</span><span class="va">rtime</span>,</span>
<span>                          <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">target_df</span><span class="op">)</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span> <span class="fl">2</span></span></code></pre></div>
<p>We have now retention times available for both the query and the
target data and can thus perform a matching based on m/z
<strong>and</strong> retention times. We use the
<code>Mass2MzRtParam</code> which allows us to specify (as for the
<code>Mass2MzParam</code>) the expected adducts, the maximal acceptable
m/z relative and absolute deviation as well as the maximal acceptable
(absolute) difference in retention times. We use the settings from the
previous section and allow a difference of 10 seconds in retention
times. The retention times are provided in columns named
<code>"rtime"</code> which is different from the default
(<code>"rt"</code>). We thus specify the name of the column containing
the retention times with parameter <code>rtColname</code>.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">parm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/matchValues.html">Mass2MzRtParam</a></span><span class="op">(</span>adducts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"[M+H]+"</span>, <span class="st">"[M+Na]+"</span><span class="op">)</span>,</span>
<span>                       tolerance <span class="op">=</span> <span class="fl">0.005</span>, ppm <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                       toleranceRt <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">matched_features</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/matchValues.html">matchValues</a></span><span class="op">(</span><span class="va">ms1_subset</span>, <span class="va">target_df</span>, param <span class="op">=</span> <span class="va">parm</span>,</span>
<span>                                rtColname <span class="op">=</span> <span class="st">"rtime"</span><span class="op">)</span></span>
<span><span class="va">matched_features</span></span></code></pre></div>
<pre><code><span><span class="co">## Object of class Matched </span></span>
<span><span class="co">## Total number of matches: 31 </span></span>
<span><span class="co">## Number of query objects: 100 (31 matched)</span></span>
<span><span class="co">## Number of target objects: 57599 (1 matched)</span></span></code></pre>
<p>Less features were matched based on m/z and retention times.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/Matched.html">matchedData</a></span><span class="op">(</span><span class="va">matched_features</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="../reference/Matched.html">whichQuery</a></span><span class="op">(</span><span class="va">matched_features</span><span class="op">)</span>, <span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## DataFrame with 31 rows and 13 columns</span></span>
<span><span class="co">##        feature_id        mz     rtime target_headgroup target_name</span></span>
<span><span class="co">##       &lt;character&gt; &lt;numeric&gt; &lt;numeric&gt;      &lt;character&gt; &lt;character&gt;</span></span>
<span><span class="co">## 1   Cluster_00...   201.113   5.87206               FA  FA 10:2;O2</span></span>
<span><span class="co">## 2   Cluster_00...   201.113   5.93346               FA  FA 10:2;O2</span></span>
<span><span class="co">## 3   Cluster_00...   201.113   6.03653               FA  FA 10:2;O2</span></span>
<span><span class="co">## 4   Cluster_00...   201.114   6.16709               FA  FA 10:2;O2</span></span>
<span><span class="co">## 5   Cluster_00...   201.113   6.31781               FA  FA 10:2;O2</span></span>
<span><span class="co">## ...           ...       ...       ...              ...         ...</span></span>
<span><span class="co">## 27  Cluster_00...   201.113   11.2722               FA  FA 10:2;O2</span></span>
<span><span class="co">## 28  Cluster_00...   201.113   11.4081               FA  FA 10:2;O2</span></span>
<span><span class="co">## 29  Cluster_00...   201.113   11.4760               FA  FA 10:2;O2</span></span>
<span><span class="co">## 30  Cluster_00...   201.114   11.5652               FA  FA 10:2;O2</span></span>
<span><span class="co">## 31  Cluster_01...   201.114   11.7752               FA  FA 10:2;O2</span></span>
<span><span class="co">##     target_exactmass target_formula target_chain_type target_rtime      adduct</span></span>
<span><span class="co">##            &lt;numeric&gt;    &lt;character&gt;       &lt;character&gt;    &lt;numeric&gt; &lt;character&gt;</span></span>
<span><span class="co">## 1            200.105       C10H16O4              even      15.8624      [M+H]+</span></span>
<span><span class="co">## 2            200.105       C10H16O4              even      15.8624      [M+H]+</span></span>
<span><span class="co">## 3            200.105       C10H16O4              even      15.8624      [M+H]+</span></span>
<span><span class="co">## 4            200.105       C10H16O4              even      15.8624      [M+H]+</span></span>
<span><span class="co">## 5            200.105       C10H16O4              even      15.8624      [M+H]+</span></span>
<span><span class="co">## ...              ...            ...               ...          ...         ...</span></span>
<span><span class="co">## 27           200.105       C10H16O4              even      15.8624      [M+H]+</span></span>
<span><span class="co">## 28           200.105       C10H16O4              even      15.8624      [M+H]+</span></span>
<span><span class="co">## 29           200.105       C10H16O4              even      15.8624      [M+H]+</span></span>
<span><span class="co">## 30           200.105       C10H16O4              even      15.8624      [M+H]+</span></span>
<span><span class="co">## 31           200.105       C10H16O4              even      15.8624      [M+H]+</span></span>
<span><span class="co">##         score ppm_error  score_rt</span></span>
<span><span class="co">##     &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt;</span></span>
<span><span class="co">## 1   0.0004538   2.25645  -9.99030</span></span>
<span><span class="co">## 2   0.0004407   2.19131  -9.92890</span></span>
<span><span class="co">## 3   0.0005655   2.81186  -9.82583</span></span>
<span><span class="co">## 4   0.0015560   7.73698  -9.69527</span></span>
<span><span class="co">## 5   0.0006845   3.40357  -9.54455</span></span>
<span><span class="co">## ...       ...       ...       ...</span></span>
<span><span class="co">## 27  0.0007312   3.63578  -4.59014</span></span>
<span><span class="co">## 28  0.0005444   2.70695  -4.45431</span></span>
<span><span class="co">## 29  0.0005328   2.64927  -4.38634</span></span>
<span><span class="co">## 30  0.0014619   7.26908  -4.29719</span></span>
<span><span class="co">## 31  0.0020342  10.11476  -4.08719</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="matching-of-summarizedexperiment-or-qfeatures-objects">Matching of <code>SummarizedExperiment</code> or
<code>QFeatures</code> objects<a class="anchor" aria-label="anchor" href="#matching-of-summarizedexperiment-or-qfeatures-objects"></a>
</h3>
<p>Results from LC-MS preprocessing (e.g. by the <em><a href="https://bioconductor.org/packages/3.22/xcms" class="external-link">xcms</a></em>
package) or generally metabolomics results might be best represented and
bundled as <code>SummarizedExperiment</code> or <code>QFeatures</code>
objects (from the same-named Bioconductor packages). A
<code>XCMSnExp</code> preprocessing result from <code>xcms</code> can
for example be converted to a <code>SummarizedExperiment</code> using
the <code>quantify()</code> method from the <code>xcms</code> package.
The feature definitions (i.e. their m/z and retention time values) will
then be stored in the object’s <code><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">rowData()</a></code> while the assay
(the numerical matrix) will contain the feature abundances across all
samples. Such <code>SummarizedExperiment</code> objects can be simply
passed as <code>query</code> objects to the <code><a href="../reference/matchValues.html">matchValues()</a></code>
method. To illustrate this, we create below a simple
<code>SummarizedExperiment</code> using the <code>ms1_features</code>
data frame from the example above as <code>rowData</code> and adding a
<code>matrix</code> with random values as assay.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://bioconductor.org/packages/SummarizedExperiment" class="external-link">SummarizedExperiment</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Loading required package: MatrixGenerics</span></span></code></pre>
<pre><code><span><span class="co">## Loading required package: matrixStats</span></span></code></pre>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Attaching package: 'MatrixGenerics'</span></span></code></pre>
<pre><code><span><span class="co">## The following objects are masked from 'package:matrixStats':</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     colAlls, colAnyNAs, colAnys, colAvgsPerRowSet, colCollapse,</span></span>
<span><span class="co">##     colCounts, colCummaxs, colCummins, colCumprods, colCumsums,</span></span>
<span><span class="co">##     colDiffs, colIQRDiffs, colIQRs, colLogSumExps, colMadDiffs,</span></span>
<span><span class="co">##     colMads, colMaxs, colMeans2, colMedians, colMins, colOrderStats,</span></span>
<span><span class="co">##     colProds, colQuantiles, colRanges, colRanks, colSdDiffs, colSds,</span></span>
<span><span class="co">##     colSums2, colTabulates, colVarDiffs, colVars, colWeightedMads,</span></span>
<span><span class="co">##     colWeightedMeans, colWeightedMedians, colWeightedSds,</span></span>
<span><span class="co">##     colWeightedVars, rowAlls, rowAnyNAs, rowAnys, rowAvgsPerColSet,</span></span>
<span><span class="co">##     rowCollapse, rowCounts, rowCummaxs, rowCummins, rowCumprods,</span></span>
<span><span class="co">##     rowCumsums, rowDiffs, rowIQRDiffs, rowIQRs, rowLogSumExps,</span></span>
<span><span class="co">##     rowMadDiffs, rowMads, rowMaxs, rowMeans2, rowMedians, rowMins,</span></span>
<span><span class="co">##     rowOrderStats, rowProds, rowQuantiles, rowRanges, rowRanks,</span></span>
<span><span class="co">##     rowSdDiffs, rowSds, rowSums2, rowTabulates, rowVarDiffs, rowVars,</span></span>
<span><span class="co">##     rowWeightedMads, rowWeightedMeans, rowWeightedMedians,</span></span>
<span><span class="co">##     rowWeightedSds, rowWeightedVars</span></span></code></pre>
<pre><code><span><span class="co">## Loading required package: GenomicRanges</span></span></code></pre>
<pre><code><span><span class="co">## Loading required package: IRanges</span></span></code></pre>
<pre><code><span><span class="co">## Loading required package: Seqinfo</span></span></code></pre>
<pre><code><span><span class="co">## Loading required package: Biobase</span></span></code></pre>
<pre><code><span><span class="co">## Welcome to Bioconductor</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     Vignettes contain introductory material; view with</span></span>
<span><span class="co">##     'browseVignettes()'. To cite Bioconductor, see</span></span>
<span><span class="co">##     'citation("Biobase")', and for packages 'citation("pkgname")'.</span></span></code></pre>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Attaching package: 'Biobase'</span></span></code></pre>
<pre><code><span><span class="co">## The following object is masked from 'package:MatrixGenerics':</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     rowMedians</span></span></code></pre>
<pre><code><span><span class="co">## The following objects are masked from 'package:matrixStats':</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     anyMissing, rowMedians</span></span></code></pre>
<pre><code><span><span class="co">## The following object is masked from 'package:AnnotationHub':</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     cache</span></span></code></pre>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">se</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">SummarizedExperiment</a></span><span class="op">(</span></span>
<span>    assays <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">ms1_features</span><span class="op">)</span> <span class="op">*</span> <span class="fl">4</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">4</span>,</span>
<span>                    dimnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="cn">NULL</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span>, <span class="st">"D"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    rowData <span class="op">=</span> <span class="va">ms1_features</span><span class="op">)</span></span></code></pre></div>
<p>We can now use the same <code><a href="../reference/matchValues.html">matchValues()</a></code> call as before to
perform the matching. Matching will be performed on the object’s
<code>rowData</code>, i.e. each row/element of the
<code>SummarizedExperiment</code> will be matched against the target
using e.g. m/z values available in columns of the object’s
<code>rowData</code>:</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">parm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/matchValues.html">Mass2MzParam</a></span><span class="op">(</span>adducts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"[M+H]+"</span>, <span class="st">"[M+Na]+"</span><span class="op">)</span>,</span>
<span>                     tolerance <span class="op">=</span> <span class="fl">0.005</span>, ppm <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">matched_features</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/matchValues.html">matchValues</a></span><span class="op">(</span><span class="va">se</span>, <span class="va">target_df</span>, param <span class="op">=</span> <span class="va">parm</span><span class="op">)</span></span>
<span><span class="va">matched_features</span></span></code></pre></div>
<pre><code><span><span class="co">## Object of class Matched </span></span>
<span><span class="co">## Total number of matches: 9173 </span></span>
<span><span class="co">## Number of query objects: 2842 (1969 matched)</span></span>
<span><span class="co">## Number of target objects: 57599 (3296 matched)</span></span></code></pre>
<p>As <code>query</code>, the result contains the full
<code>SummarizedExperiment</code>, but <code><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames()</a></code> and
<code><a href="../reference/Matched.html">matchedData()</a></code> will access the respective information from
the <code>rowData</code> of this <code>SummarizedExperiment</code>:</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">matched_features</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] "feature_id"        "mz"                "rtime"            </span></span>
<span><span class="co">##  [4] "target_headgroup"  "target_name"       "target_exactmass" </span></span>
<span><span class="co">##  [7] "target_formula"    "target_chain_type" "target_rtime"     </span></span>
<span><span class="co">## [10] "adduct"            "score"             "ppm_error"</span></span></code></pre>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/Matched.html">matchedData</a></span><span class="op">(</span><span class="va">matched_features</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## DataFrame with 10046 rows and 12 columns</span></span>
<span><span class="co">##          feature_id        mz     rtime target_headgroup   target_name</span></span>
<span><span class="co">##         &lt;character&gt; &lt;numeric&gt; &lt;numeric&gt;      &lt;character&gt;   &lt;character&gt;</span></span>
<span><span class="co">## 1     Cluster_00...   102.128   1.56015               NA            NA</span></span>
<span><span class="co">## 2     Cluster_00...   102.128   2.15359               NA            NA</span></span>
<span><span class="co">## 3     Cluster_00...   102.128   2.92557               NA            NA</span></span>
<span><span class="co">## 4     Cluster_00...   102.128   3.41962               NA            NA</span></span>
<span><span class="co">## 5     Cluster_00...   102.127   5.80104               NA            NA</span></span>
<span><span class="co">## ...             ...       ...       ...              ...           ...</span></span>
<span><span class="co">## 10042 Cluster_28...   957.771   20.2705               TG    TG 54:2;O3</span></span>
<span><span class="co">## 10043 Cluster_28...   960.791   20.8865           HexCer HexCer 52:...</span></span>
<span><span class="co">## 10044 Cluster_28...   961.361   13.0214               NA            NA</span></span>
<span><span class="co">## 10045 Cluster_28...   970.873   22.0981             ACer ACer 60:1;...</span></span>
<span><span class="co">## 10046 Cluster_28...   972.734   15.6914          Hex2Cer Hex2Cer 42...</span></span>
<span><span class="co">##       target_exactmass target_formula target_chain_type target_rtime</span></span>
<span><span class="co">##              &lt;numeric&gt;    &lt;character&gt;       &lt;character&gt;    &lt;numeric&gt;</span></span>
<span><span class="co">## 1                   NA             NA                NA           NA</span></span>
<span><span class="co">## 2                   NA             NA                NA           NA</span></span>
<span><span class="co">## 3                   NA             NA                NA           NA</span></span>
<span><span class="co">## 4                   NA             NA                NA           NA</span></span>
<span><span class="co">## 5                   NA             NA                NA           NA</span></span>
<span><span class="co">## ...                ...            ...               ...          ...</span></span>
<span><span class="co">## 10042          934.784      C57H106O9              even      15.9950</span></span>
<span><span class="co">## 10043          959.779     C58H105NO9              even      10.5076</span></span>
<span><span class="co">## 10044               NA             NA                NA           NA</span></span>
<span><span class="co">## 10045          947.888     C60H117NO6              even       4.2806</span></span>
<span><span class="co">## 10046          971.727  C54H101NO1...              even      19.7329</span></span>
<span><span class="co">##            adduct      score ppm_error</span></span>
<span><span class="co">##       &lt;character&gt;  &lt;numeric&gt; &lt;numeric&gt;</span></span>
<span><span class="co">## 1              NA         NA        NA</span></span>
<span><span class="co">## 2              NA         NA        NA</span></span>
<span><span class="co">## 3              NA         NA        NA</span></span>
<span><span class="co">## 4              NA         NA        NA</span></span>
<span><span class="co">## 5              NA         NA        NA</span></span>
<span><span class="co">## ...           ...        ...       ...</span></span>
<span><span class="co">## 10042     [M+Na]+ -0.0021897  2.286241</span></span>
<span><span class="co">## 10043      [M+H]+  0.0045398  4.725089</span></span>
<span><span class="co">## 10044          NA         NA        NA</span></span>
<span><span class="co">## 10045     [M+Na]+ -0.0045054  4.640545</span></span>
<span><span class="co">## 10046      [M+H]+ -0.0004240  0.435885</span></span></code></pre>
<p>Subsetting the result object, to e.g. just matched elements will also
subset the <code>SummarizedExperiment</code>.</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">matched_sub</span> <span class="op">&lt;-</span> <span class="va">matched_features</span><span class="op">[</span><span class="fu"><a href="../reference/Matched.html">whichQuery</a></span><span class="op">(</span><span class="va">matched_features</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="fu">MetaboAnnotation</span><span class="fu">::</span><span class="fu">query</span><span class="op">(</span><span class="va">matched_sub</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## class: SummarizedExperiment </span></span>
<span><span class="co">## dim: 1969 4 </span></span>
<span><span class="co">## metadata(0):</span></span>
<span><span class="co">## assays(1): ''</span></span>
<span><span class="co">## rownames: NULL</span></span>
<span><span class="co">## rowData names(3): feature_id mz rtime</span></span>
<span><span class="co">## colnames(4): A B C D</span></span>
<span><span class="co">## colData names(0):</span></span></code></pre>
<p>A <code>QFeatures</code> object is essentially a container for
several <code>SummarizedExperiment</code> objects which rows (features)
are related with each other. Such an object could thus for example
contain the full feature data from an LC-MS experiment as one assay and
a compounded feature data in which data from ions of the same compound
are aggregated as an additional assay. Below we create such an object
using our <code>SummarizedExperiment</code> as an assay of name
<code>"features"</code>. For now we don’t add any additional assay to
that <code>QFeatures</code>, thus, the object contains only this single
data set.</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/QFeatures" class="external-link">QFeatures</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Loading required package: MultiAssayExperiment</span></span></code></pre>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Attaching package: 'QFeatures'</span></span></code></pre>
<pre><code><span><span class="co">## The following object is masked from 'package:base':</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     sweep</span></span></code></pre>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">qf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/QFeatures/man/QFeatures-class.html" class="external-link">QFeatures</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>features <span class="op">=</span> <span class="va">se</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">qf</span></span></code></pre></div>
<pre><code><span><span class="co">## An instance of class QFeatures (type: bulk) with 1 set:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##  [1] features: SummarizedExperiment with 2842 rows and 4 columns</span></span></code></pre>
<p><code><a href="../reference/matchValues.html">matchValues()</a></code> supports also matching of
<code>QFeatures</code> objects but the user needs to define the assay
which should be used for the matching with the <code>queryAssay</code>
parameter.</p>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">matched_qf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/matchValues.html">matchValues</a></span><span class="op">(</span><span class="va">qf</span>, <span class="va">target_df</span>, param <span class="op">=</span> <span class="va">parm</span>, queryAssay <span class="op">=</span> <span class="st">"features"</span><span class="op">)</span></span>
<span><span class="va">matched_qf</span></span></code></pre></div>
<pre><code><span><span class="co">## Object of class Matched </span></span>
<span><span class="co">## Total number of matches: 9173 </span></span>
<span><span class="co">## Number of query objects: 2842 (1969 matched)</span></span>
<span><span class="co">## Number of target objects: 57599 (3296 matched)</span></span></code></pre>
<p><code><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames()</a></code> and <code><a href="../reference/Matched.html">matchedData()</a></code> allow to
access the <code>rowData</code> of the <code>SummarizedExperiment</code>
stored in the <code>QFeatures</code>’ <code>"features"</code> assay:</p>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">matched_qf</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] "feature_id"        "mz"                "rtime"            </span></span>
<span><span class="co">##  [4] "target_headgroup"  "target_name"       "target_exactmass" </span></span>
<span><span class="co">##  [7] "target_formula"    "target_chain_type" "target_rtime"     </span></span>
<span><span class="co">## [10] "adduct"            "score"             "ppm_error"</span></span></code></pre>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/Matched.html">matchedData</a></span><span class="op">(</span><span class="va">matched_qf</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## DataFrame with 10046 rows and 12 columns</span></span>
<span><span class="co">##          feature_id        mz     rtime target_headgroup   target_name</span></span>
<span><span class="co">##         &lt;character&gt; &lt;numeric&gt; &lt;numeric&gt;      &lt;character&gt;   &lt;character&gt;</span></span>
<span><span class="co">## 1     Cluster_00...   102.128   1.56015               NA            NA</span></span>
<span><span class="co">## 2     Cluster_00...   102.128   2.15359               NA            NA</span></span>
<span><span class="co">## 3     Cluster_00...   102.128   2.92557               NA            NA</span></span>
<span><span class="co">## 4     Cluster_00...   102.128   3.41962               NA            NA</span></span>
<span><span class="co">## 5     Cluster_00...   102.127   5.80104               NA            NA</span></span>
<span><span class="co">## ...             ...       ...       ...              ...           ...</span></span>
<span><span class="co">## 10042 Cluster_28...   957.771   20.2705               TG    TG 54:2;O3</span></span>
<span><span class="co">## 10043 Cluster_28...   960.791   20.8865           HexCer HexCer 52:...</span></span>
<span><span class="co">## 10044 Cluster_28...   961.361   13.0214               NA            NA</span></span>
<span><span class="co">## 10045 Cluster_28...   970.873   22.0981             ACer ACer 60:1;...</span></span>
<span><span class="co">## 10046 Cluster_28...   972.734   15.6914          Hex2Cer Hex2Cer 42...</span></span>
<span><span class="co">##       target_exactmass target_formula target_chain_type target_rtime</span></span>
<span><span class="co">##              &lt;numeric&gt;    &lt;character&gt;       &lt;character&gt;    &lt;numeric&gt;</span></span>
<span><span class="co">## 1                   NA             NA                NA           NA</span></span>
<span><span class="co">## 2                   NA             NA                NA           NA</span></span>
<span><span class="co">## 3                   NA             NA                NA           NA</span></span>
<span><span class="co">## 4                   NA             NA                NA           NA</span></span>
<span><span class="co">## 5                   NA             NA                NA           NA</span></span>
<span><span class="co">## ...                ...            ...               ...          ...</span></span>
<span><span class="co">## 10042          934.784      C57H106O9              even      15.9950</span></span>
<span><span class="co">## 10043          959.779     C58H105NO9              even      10.5076</span></span>
<span><span class="co">## 10044               NA             NA                NA           NA</span></span>
<span><span class="co">## 10045          947.888     C60H117NO6              even       4.2806</span></span>
<span><span class="co">## 10046          971.727  C54H101NO1...              even      19.7329</span></span>
<span><span class="co">##            adduct      score ppm_error</span></span>
<span><span class="co">##       &lt;character&gt;  &lt;numeric&gt; &lt;numeric&gt;</span></span>
<span><span class="co">## 1              NA         NA        NA</span></span>
<span><span class="co">## 2              NA         NA        NA</span></span>
<span><span class="co">## 3              NA         NA        NA</span></span>
<span><span class="co">## 4              NA         NA        NA</span></span>
<span><span class="co">## 5              NA         NA        NA</span></span>
<span><span class="co">## ...           ...        ...       ...</span></span>
<span><span class="co">## 10042     [M+Na]+ -0.0021897  2.286241</span></span>
<span><span class="co">## 10043      [M+H]+  0.0045398  4.725089</span></span>
<span><span class="co">## 10044          NA         NA        NA</span></span>
<span><span class="co">## 10045     [M+Na]+ -0.0045054  4.640545</span></span>
<span><span class="co">## 10046      [M+H]+ -0.0004240  0.435885</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="matching-of-msms-spectra">Matching of MS/MS spectra<a class="anchor" aria-label="anchor" href="#matching-of-msms-spectra"></a>
</h3>
<p>In this section we match experimental MS/MS spectra against reference
spectra. This can also be performed with functions from the <em><a href="https://bioconductor.org/packages/3.22/Spectra" class="external-link">Spectra</a></em>
package (see <a href="https://jorainer.github.io/SpectraTutorials/" class="external-link">SpectraTutorials</a>,
but the functions and concepts used here are more suitable to the
<em>end user</em> as they simplify the handling of the spectra matching
results.</p>
<p>Below we load spectra from a file from a reversed-phase (DDA)
LC-MS/MS run of the Agilent Pesticide mix. With
<code><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">filterMsLevel()</a></code> we subset the data set to only MS2 spectra.
To reduce processing time of the example we further subset the
<code>Spectra</code> to a small set of selected MS2 spectra. In addition
we assign <em>feature identifiers</em> to each spectrum (again, for this
example these are arbitrary IDs, but in a <em>real</em> data analysis
such identifiers could indicate to which LC-MS feature these spectra
belong).</p>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/Spectra" class="external-link">Spectra</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">msdata</span><span class="op">)</span></span>
<span><span class="va">fl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"TripleTOF-SWATH"</span>, <span class="st">"PestMix1_DDA.mzML"</span>, package <span class="op">=</span> <span class="st">"msdata"</span><span class="op">)</span></span>
<span><span class="va">pest_ms2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">filterMsLevel</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/Spectra.html" class="external-link">Spectra</a></span><span class="op">(</span><span class="va">fl</span><span class="op">)</span>, <span class="fl">2L</span><span class="op">)</span></span>
<span><span class="co">## subset to selected spectra.</span></span>
<span><span class="va">pest_ms2</span> <span class="op">&lt;-</span> <span class="va">pest_ms2</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">808</span>, <span class="fl">809</span>, <span class="fl">945</span><span class="op">:</span><span class="fl">955</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co">## assign arbitrary *feature IDs* to each spectrum.</span></span>
<span><span class="va">pest_ms2</span><span class="op">$</span><span class="va">feature_id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"FT001"</span>, <span class="st">"FT001"</span>, <span class="st">"FT002"</span>, <span class="st">"FT003"</span>, <span class="st">"FT003"</span>, <span class="st">"FT003"</span>,</span>
<span>                         <span class="st">"FT004"</span>, <span class="st">"FT004"</span>, <span class="st">"FT004"</span>, <span class="st">"FT005"</span>, <span class="st">"FT005"</span>, <span class="st">"FT006"</span>,</span>
<span>                         <span class="st">"FT006"</span><span class="op">)</span></span>
<span><span class="co">## assign also *spectra IDs* to each</span></span>
<span><span class="va">pest_ms2</span><span class="op">$</span><span class="va">spectrum_id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"sp_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">pest_ms2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">pest_ms2</span></span></code></pre></div>
<pre><code><span><span class="co">## MSn data (Spectra) with 13 spectra in a MsBackendMzR backend:</span></span>
<span><span class="co">##       msLevel     rtime scanIndex</span></span>
<span><span class="co">##     &lt;integer&gt; &lt;numeric&gt; &lt;integer&gt;</span></span>
<span><span class="co">## 1           2   361.651      2853</span></span>
<span><span class="co">## 2           2   361.741      2854</span></span>
<span><span class="co">## 3           2   377.609      3030</span></span>
<span><span class="co">## 4           2   377.699      3031</span></span>
<span><span class="co">## 5           2   378.120      3033</span></span>
<span><span class="co">## ...       ...       ...       ...</span></span>
<span><span class="co">## 9           2   378.959      3039</span></span>
<span><span class="co">## 10          2   379.379      3041</span></span>
<span><span class="co">## 11          2   380.059      3045</span></span>
<span><span class="co">## 12          2   380.609      3048</span></span>
<span><span class="co">## 13          2   381.029      3050</span></span>
<span><span class="co">##  ... 36 more variables/columns.</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## file(s):</span></span>
<span><span class="co">## PestMix1_DDA.mzML</span></span>
<span><span class="co">## Processing:</span></span>
<span><span class="co">##  Filter: select MS level(s) 2 [Tue Oct 14 08:02:28 2025]</span></span></code></pre>
<p>This <code>Spectra</code> should now represent MS2 spectra associated
with LC-MS features from an untargeted LC-MS/MS experiment that we would
like to annotate by matching them against a spectral reference
library.</p>
<p>We thus load below a <code>Spectra</code> object that represents MS2
data from a very small subset of <a href="https://massbank.eu/MassBank/" class="external-link">MassBank</a> release
<em>2021.03</em>. This small <code>Spectra</code> object is provided
within this package but it would be possible to use any other
<code>Spectra</code> object with reference fragment spectra instead (see
also the <a href="https://jorainer.github.io/SpectraTutorials/" class="external-link">SpectraTutorials</a>
workshop). As an alternative, it would also be possible to use a
<code>CompDb</code> object representing a compound annotation database
(defined in the <em><a href="https://bioconductor.org/packages/3.22/CompoundDb" class="external-link">CompoundDb</a></em>
package) with parameter <code>target</code>. See the
<code><a href="../reference/matchSpectra.html">matchSpectra()</a></code> help page or section <em>Query against
multiple reference databases</em> below for more details and options to
retrieve such annotation resources from Bioconductor’s <em><a href="https://bioconductor.org/packages/3.22/AnnotationHub" class="external-link">AnnotationHub</a></em>.</p>
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"minimb.RData"</span>, package <span class="op">=</span> <span class="st">"MetaboAnnotation"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">minimb</span></span></code></pre></div>
<pre><code><span><span class="co">## MSn data (Spectra) with 100 spectra in a MsBackendDataFrame backend:</span></span>
<span><span class="co">##       msLevel     rtime scanIndex</span></span>
<span><span class="co">##     &lt;integer&gt; &lt;numeric&gt; &lt;integer&gt;</span></span>
<span><span class="co">## 1           2        NA        NA</span></span>
<span><span class="co">## 2           2        NA        NA</span></span>
<span><span class="co">## 3           2        NA        NA</span></span>
<span><span class="co">## 4           2        NA        NA</span></span>
<span><span class="co">## 5           2        NA        NA</span></span>
<span><span class="co">## ...       ...       ...       ...</span></span>
<span><span class="co">## 96         NA        NA        NA</span></span>
<span><span class="co">## 97          2        NA        NA</span></span>
<span><span class="co">## 98          2        NA        NA</span></span>
<span><span class="co">## 99          2        NA        NA</span></span>
<span><span class="co">## 100         2        NA        NA</span></span>
<span><span class="co">##  ... 42 more variables/columns.</span></span>
<span><span class="co">## Processing:</span></span>
<span><span class="co">##  Filter: select spectra with polarity 1 [Wed Mar 31 10:06:28 2021]</span></span>
<span><span class="co">##  Switch backend from MsBackendMassbankSql to MsBackendDataFrame [Wed Mar 31 10:07:59 2021]</span></span></code></pre>
<p>We can now use the <code><a href="../reference/matchSpectra.html">matchSpectra()</a></code> function to match each
of our experimental <em>query</em> spectra against the <em>target</em>
(reference) spectra. Settings for this matching can be defined with a
dedicated <em>param</em> object. We use below the
<code>CompareSpectraParam</code> that uses the
<code><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">compareSpectra()</a></code> function from the <code>Spectra</code>
package to calculate similarities between each query spectrum and all
target spectra. <code>CompareSpectraParam</code> allows to set all
individual settings for the <code><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">compareSpectra()</a></code> call with
parameters <code>MAPFUN</code>, <code>ppm</code>, <code>tolerance</code>
and <code>FUN</code> (see the help on <code><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">compareSpectra()</a></code> in
the <em><a href="https://bioconductor.org/packages/3.22/Spectra" class="external-link">Spectra</a></em>
package for more details). In addition, we can <em>pre-filter</em> the
target spectra for each individual query spectrum to speed-up the
calculations. By setting <code>requirePrecursor = TRUE</code> we compare
below each query spectrum only to target spectra with matching precursor
m/z (accepting a deviation defined by parameters <code>ppm</code> and
<code>tolerance</code>). By default, <code><a href="../reference/matchSpectra.html">matchSpectra()</a></code> with
<code>CompareSpectraParam</code> considers spectra with a similarity
score higher than 0.7 as <em>matching</em> and these are thus reported.
As an additional configuration we set
<code>matchedPeaksCount = TRUE</code> to report the number of matching
peaks between the compared (and matched) spectra.</p>
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">csp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CompareSpectraParam.html">CompareSpectraParam</a></span><span class="op">(</span>requirePrecursor <span class="op">=</span> <span class="cn">TRUE</span>, ppm <span class="op">=</span> <span class="fl">10</span>,</span>
<span>                           matchedPeaksCount <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">mtches</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/matchSpectra.html">matchSpectra</a></span><span class="op">(</span><span class="va">pest_ms2</span>, <span class="va">minimb</span>, param <span class="op">=</span> <span class="va">csp</span><span class="op">)</span></span>
<span><span class="va">mtches</span></span></code></pre></div>
<pre><code><span><span class="co">## Object of class MatchedSpectra </span></span>
<span><span class="co">## Total number of matches: 16 </span></span>
<span><span class="co">## Number of query objects: 13 (5 matched)</span></span>
<span><span class="co">## Number of target objects: 100 (11 matched)</span></span></code></pre>
<p>The results are reported as a <code>MatchedSpectra</code> object
which represents the matching results for all query spectra. This type
of object contains all query spectra, all target spectra, the matching
information and the parameter object with the settings of the matching.
The object can be subset to results of selected <strong>query</strong>
spectra using the <code>[</code> method. The length of the result object
matches thus the number of query spectra:</p>
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">pest_ms2</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 13</span></span></code></pre>
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">mtches</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 13</span></span></code></pre>
<p>To subset to the results for the first query spectrum:</p>
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mtches</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## Object of class MatchedSpectra </span></span>
<span><span class="co">## Total number of matches: 0 </span></span>
<span><span class="co">## Number of query objects: 1 (0 matched)</span></span>
<span><span class="co">## Number of target objects: 100 (0 matched)</span></span></code></pre>
<p>In this case, for the first query spectrum, no match was found among
the target spectra. Below we subset the <code>MatchedSpectra</code> to
results for the second query spectrum:</p>
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mtches</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## Object of class MatchedSpectra </span></span>
<span><span class="co">## Total number of matches: 4 </span></span>
<span><span class="co">## Number of query objects: 1 (1 matched)</span></span>
<span><span class="co">## Number of target objects: 100 (4 matched)</span></span></code></pre>
<p>The second query spectrum could be matched to 4 target spectra. The
matching between query and target spectra can be n:m, i.e. each query
spectrum can match no or multiple target spectra and each target
spectrum can be matched to none, one or multiple query spectra.</p>
<p>Data (spectra variables of either the query and/or the target
spectra) can be extracted from the result object with the
<code><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">spectraData()</a></code> function or with <code>$</code> (similar to a
<code>Spectra</code> object). The <code>spectraVariables</code> function
can be used to list all available spectra variables in the result
object:</p>
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">spectraVariables</a></span><span class="op">(</span><span class="va">mtches</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] "msLevel"                        "rtime"                         </span></span>
<span><span class="co">##  [3] "acquisitionNum"                 "scanIndex"                     </span></span>
<span><span class="co">##  [5] "dataStorage"                    "dataOrigin"                    </span></span>
<span><span class="co">##  [7] "centroided"                     "smoothed"                      </span></span>
<span><span class="co">##  [9] "polarity"                       "precScanNum"                   </span></span>
<span><span class="co">## [11] "precursorMz"                    "precursorIntensity"            </span></span>
<span><span class="co">## [13] "precursorCharge"                "collisionEnergy"               </span></span>
<span><span class="co">## [15] "isolationWindowLowerMz"         "isolationWindowTargetMz"       </span></span>
<span><span class="co">## [17] "isolationWindowUpperMz"         "peaksCount"                    </span></span>
<span><span class="co">## [19] "totIonCurrent"                  "basePeakMZ"                    </span></span>
<span><span class="co">## [21] "basePeakIntensity"              "electronBeamEnergy"            </span></span>
<span><span class="co">## [23] "ionisationEnergy"               "lowMZ"                         </span></span>
<span><span class="co">## [25] "highMZ"                         "mergedScan"                    </span></span>
<span><span class="co">## [27] "mergedResultScanNum"            "mergedResultStartScanNum"      </span></span>
<span><span class="co">## [29] "mergedResultEndScanNum"         "injectionTime"                 </span></span>
<span><span class="co">## [31] "filterString"                   "spectrumId"                    </span></span>
<span><span class="co">## [33] "ionMobilityDriftTime"           "scanWindowLowerLimit"          </span></span>
<span><span class="co">## [35] "scanWindowUpperLimit"           "feature_id"                    </span></span>
<span><span class="co">## [37] "spectrum_id"                    ".original_query_index"         </span></span>
<span><span class="co">## [39] "target_msLevel"                 "target_rtime"                  </span></span>
<span><span class="co">## [41] "target_acquisitionNum"          "target_scanIndex"              </span></span>
<span><span class="co">## [43] "target_dataStorage"             "target_dataOrigin"             </span></span>
<span><span class="co">## [45] "target_centroided"              "target_smoothed"               </span></span>
<span><span class="co">## [47] "target_polarity"                "target_precScanNum"            </span></span>
<span><span class="co">## [49] "target_precursorMz"             "target_precursorIntensity"     </span></span>
<span><span class="co">## [51] "target_precursorCharge"         "target_collisionEnergy"        </span></span>
<span><span class="co">## [53] "target_isolationWindowLowerMz"  "target_isolationWindowTargetMz"</span></span>
<span><span class="co">## [55] "target_isolationWindowUpperMz"  "target_spectrum_id"            </span></span>
<span><span class="co">## [57] "target_spectrum_name"           "target_date"                   </span></span>
<span><span class="co">## [59] "target_authors"                 "target_license"                </span></span>
<span><span class="co">## [61] "target_copyright"               "target_publication"            </span></span>
<span><span class="co">## [63] "target_splash"                  "target_compound_id"            </span></span>
<span><span class="co">## [65] "target_adduct"                  "target_ionization"             </span></span>
<span><span class="co">## [67] "target_ionization_voltage"      "target_fragmentation_mode"     </span></span>
<span><span class="co">## [69] "target_collision_energy_text"   "target_instrument"             </span></span>
<span><span class="co">## [71] "target_instrument_type"         "target_formula"                </span></span>
<span><span class="co">## [73] "target_exactmass"               "target_smiles"                 </span></span>
<span><span class="co">## [75] "target_inchi"                   "target_inchikey"               </span></span>
<span><span class="co">## [77] "target_cas"                     "target_pubchem"                </span></span>
<span><span class="co">## [79] "target_synonym"                 "target_precursor_mz_text"      </span></span>
<span><span class="co">## [81] "target_compound_name"           "score"                         </span></span>
<span><span class="co">## [83] "matched_peaks_count"</span></span></code></pre>
<p>This lists the spectra variables from both the <em>query</em>
<strong>and</strong> the <em>target</em> spectra, with the prefix
<code>"target_"</code> being used for spectra variable names of the
target spectra. Spectra variable <code>"score"</code> contains the
similarity score. If <code>matchedPeaksCount = TRUE</code> was used, a
column <code>"matched_peaks_count"</code> is available that lists the
number of matching peaks between the compared spectra.</p>
<p>Note that by default also an additional column
<code>".original_query_index"</code> is added to the <code>query</code>
<code>Spectra</code> object by the <code><a href="../reference/matchSpectra.html">matchSpectra()</a></code> function,
that enables an easier mapping of results to the <em>original</em> query
object used as input, in particular, if the <code>MatchedSpectra</code>
object gets further subset. As the name says, this column contains for
each query spectrum the index in the original <code>Spectra</code>
object provided with the <code>query</code> parameter.</p>
<p>We could thus use <code>$target_compound_name</code> to extract the
compound name of the matching target spectra for the second query
spectrum:</p>
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mtches</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">$</span><span class="va">target_compound_name</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "Azaconazole" "Azaconazole" "Azaconazole" "Azaconazole"</span></span></code></pre>
<p>The same information can also be extracted on the <em>full</em>
<code>MatchedSpectra</code>. Below we use <code>$spectrum_id</code> to
extract the query spectra identifiers we added above from the full
result object.</p>
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mtches</span><span class="op">$</span><span class="va">spectrum_id</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] "sp_1"  "sp_2"  "sp_2"  "sp_2"  "sp_2"  "sp_3"  "sp_4"  "sp_4"  "sp_5" </span></span>
<span><span class="co">## [10] "sp_6"  "sp_6"  "sp_6"  "sp_7"  "sp_8"  "sp_8"  "sp_8"  "sp_8"  "sp_8" </span></span>
<span><span class="co">## [19] "sp_9"  "sp_9"  "sp_10" "sp_11" "sp_12" "sp_13"</span></span></code></pre>
<p>We added this column manually to the query object before the
<code><a href="../reference/matchSpectra.html">matchSpectra()</a></code> call, but the automatically added spectra
variable <code>".original_query_index"</code> would provide the same
information:</p>
<div class="sourceCode" id="cb84"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mtches</span><span class="op">$</span><span class="va">.original_query_index</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1]  1  2  2  2  2  3  4  4  5  6  6  6  7  8  8  8  8  8  9  9 10 11 12 13</span></span></code></pre>
<p>And the respective values in the query object:</p>
<div class="sourceCode" id="cb86"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">query</span><span class="op">(</span><span class="va">mtches</span><span class="op">)</span><span class="op">$</span><span class="va">.original_query_index</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1]  1  2  3  4  5  6  7  8  9 10 11 12 13</span></span></code></pre>
<p>Because of the n:m mapping between query and target spectra, the
number of values returned by <code>$</code> (or
<code>spectraData</code>) can be larger than the total number of query
spectra. Also in the example above, some of the spectra IDs are present
more than once in the result returned by <code>$spectrum_id</code>. The
respective spectra could be matched to more than one target spectrum
(based on our settings) and hence their IDs are reported multiple times.
Both <code>spectraData</code> and <code>$</code> for
<code>MatchedSpectra</code> use a <em>left join</em> strategy to
report/return values: a value (row) is reported for each query spectrum
(even if it does <strong>not</strong> match any target spectrum) with
eventually duplicated values (rows) if the query spectrum matches more
than one target spectrum (each value for a query spectrum is repeated as
many times as it matches target spectra). To illustrate this we use
below the <code><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">spectraData()</a></code> function to extract specific data
from our result object, i.e. the spectrum and feature IDs for the query
spectra we defined above, the MS2 spectra similarity score, and the
target spectra’s ID and compound name.</p>
<div class="sourceCode" id="cb88"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mtches_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">spectraData</a></span><span class="op">(</span><span class="va">mtches</span>, columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"spectrum_id"</span>, <span class="st">"feature_id"</span>,</span>
<span>                                             <span class="st">"score"</span>, <span class="st">"target_spectrum_id"</span>,</span>
<span>                                             <span class="st">"target_compound_name"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">mtches_df</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    spectrum_id feature_id     score target_spectrum_id    target_compound_name</span></span>
<span><span class="co">## 1         sp_1      FT001        NA               &lt;NA&gt;                    &lt;NA&gt;</span></span>
<span><span class="co">## 2         sp_2      FT001 0.7869556           LU056604             Azaconazole</span></span>
<span><span class="co">## 3         sp_2      FT001 0.8855473           LU056603             Azaconazole</span></span>
<span><span class="co">## 4         sp_2      FT001 0.7234894           LU056602             Azaconazole</span></span>
<span><span class="co">## 5         sp_2      FT001 0.7219942           LU056605             Azaconazole</span></span>
<span><span class="co">## 6         sp_3      FT002        NA               &lt;NA&gt;                    &lt;NA&gt;</span></span>
<span><span class="co">## 7         sp_4      FT003 0.7769746           KW108103 triphenylphosphineoxide</span></span>
<span><span class="co">## 8         sp_4      FT003 0.7577286           KW108102 triphenylphosphineoxide</span></span>
<span><span class="co">## 9         sp_5      FT003        NA               &lt;NA&gt;                    &lt;NA&gt;</span></span>
<span><span class="co">## 10        sp_6      FT003 0.7433718           SM839501            Dimethachlor</span></span>
<span><span class="co">## 11        sp_6      FT003 0.7019807           EA070705            Dimethachlor</span></span>
<span><span class="co">## 12        sp_6      FT003 0.7081274           EA070711            Dimethachlor</span></span>
<span><span class="co">## 13        sp_7      FT004        NA               &lt;NA&gt;                    &lt;NA&gt;</span></span>
<span><span class="co">## 14        sp_8      FT004 0.7320465           SM839501            Dimethachlor</span></span>
<span><span class="co">## 15        sp_8      FT004 0.8106258           EA070705            Dimethachlor</span></span>
<span><span class="co">## 16        sp_8      FT004 0.7290458           EA070710            Dimethachlor</span></span>
<span><span class="co">## 17        sp_8      FT004 0.8168876           EA070711            Dimethachlor</span></span>
<span><span class="co">## 18        sp_8      FT004 0.7247800           EA070704            Dimethachlor</span></span>
<span><span class="co">## 19        sp_9      FT004 0.7412586           KW108103 triphenylphosphineoxide</span></span>
<span><span class="co">## 20        sp_9      FT004 0.7198787           KW108102 triphenylphosphineoxide</span></span>
<span><span class="co">## 21       sp_10      FT005        NA               &lt;NA&gt;                    &lt;NA&gt;</span></span>
<span><span class="co">## 22       sp_11      FT005        NA               &lt;NA&gt;                    &lt;NA&gt;</span></span>
<span><span class="co">## 23       sp_12      FT006        NA               &lt;NA&gt;                    &lt;NA&gt;</span></span>
<span><span class="co">## 24       sp_13      FT006        NA               &lt;NA&gt;                    &lt;NA&gt;</span></span></code></pre>
<p>Using the <code><a href="https://rdrr.io/pkg/Spectra/man/spectra-plotting.html" class="external-link">plotSpectraMirror()</a></code> function we can visualize
the matching results for one query spectrum. Note also that an
interactive, <code>shiny</code>-based, validation of matching results is
available with the <code><a href="../reference/validateMatchedSpectra.html">validateMatchedSpectra()</a></code> function. Below
we call this function to show all matches for the second spectrum.</p>
<div class="sourceCode" id="cb90"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/spectra-plotting.html" class="external-link">plotSpectraMirror</a></span><span class="op">(</span><span class="va">mtches</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p><img src="MetaboAnnotation_files/figure-html/unnamed-chunk-33-1.png" width="700"></p>
<p>Not unexpectedly, the peak intensities of query and target spectra
are on different scales. While this was no problem for the similarity
calculation (the normalized dot-product which is used by default is
independent of the absolute peak values) it is not ideal for
visualization. Thus, we apply below a simple scaling function to both
the query and target spectra and plot the spectra again afterwards (see
the help for <code><a href="https://rdrr.io/pkg/ProtGenerics/man/processingQueue.html" class="external-link">addProcessing()</a></code> in the <code>Spectra</code>
package for more details on spectra data manipulations). This function
will replace the absolute spectra intensities with intensities relative
to the maximum intensity of each spectrum. Note that functions for
<code><a href="https://rdrr.io/pkg/ProtGenerics/man/processingQueue.html" class="external-link">addProcessing()</a></code> should include (like in the example below)
the <code>...</code> parameter.</p>
<div class="sourceCode" id="cb91"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">scale_int</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">x</span><span class="op">[</span>, <span class="st">"intensity"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">[</span>, <span class="st">"intensity"</span><span class="op">]</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span>, <span class="st">"intensity"</span><span class="op">]</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="va">x</span></span>
<span><span class="op">}</span></span>
<span><span class="va">mtches</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/processingQueue.html" class="external-link">addProcessing</a></span><span class="op">(</span><span class="va">mtches</span>, <span class="va">scale_int</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/spectra-plotting.html" class="external-link">plotSpectraMirror</a></span><span class="op">(</span><span class="va">mtches</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p><img src="MetaboAnnotation_files/figure-html/unnamed-chunk-34-1.png" width="700"></p>
<p>The query spectrum seems to nicely match the identified target
spectra. Below we extract the compound name of the target spectra for
this second query spectrum.</p>
<div class="sourceCode" id="cb92"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mtches</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">$</span><span class="va">target_compound_name</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "Azaconazole" "Azaconazole" "Azaconazole" "Azaconazole"</span></span></code></pre>
<p>As alternative to the <code>CompareSpectraParam</code> we could also
use the <code>MatchForwardReverseParam</code> with
<code><a href="../reference/matchSpectra.html">matchSpectra()</a></code>. This has the same settings and performs the
same spectra similarity search than <code>CompareSpectraParam</code>,
but reports in addition (similar to MS-DIAL) to the (<em>forward</em>)
similarity score also the <em>reverse</em> spectra similarity score as
well as the <em>presence ratio</em> for matching spectra. While the
default <em>forward</em> score is calculated considering all peaks from
the query and the target spectrum (the peak mapping is performed using
an <em>outer join</em> strategy), the <em>reverse score</em> is
calculated only on peaks that are present in the target spectrum and the
matching peaks from the query spectrum (the peak mapping is performed
using a <em>right join</em> strategy). The <em>presence ratio</em> is
the ratio between the number of mapped peaks between the query and the
target spectrum and the total number of peaks in the target spectrum.
These values are available as spectra variables
<code>"reverse_score"</code> and <code>"presence_ratio"</code> in the
result object). Below we perform the same spectra matching as above, but
using the <code>MatchForwardReverseParam</code>.</p>
<div class="sourceCode" id="cb94"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CompareSpectraParam.html">MatchForwardReverseParam</a></span><span class="op">(</span>requirePrecursor <span class="op">=</span> <span class="cn">TRUE</span>, ppm <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">mtches</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/matchSpectra.html">matchSpectra</a></span><span class="op">(</span><span class="va">pest_ms2</span>, <span class="va">minimb</span>, param <span class="op">=</span> <span class="va">mp</span><span class="op">)</span></span>
<span><span class="va">mtches</span></span></code></pre></div>
<pre><code><span><span class="co">## Object of class MatchedSpectra </span></span>
<span><span class="co">## Total number of matches: 16 </span></span>
<span><span class="co">## Number of query objects: 13 (5 matched)</span></span>
<span><span class="co">## Number of target objects: 100 (11 matched)</span></span></code></pre>
<p>Below we extract the query and target spectra IDs, the compound name
and all scores.</p>
<div class="sourceCode" id="cb96"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">spectraData</a></span><span class="op">(</span><span class="va">mtches</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"spectrum_id"</span>, <span class="st">"target_spectrum_id"</span>,</span>
<span>                          <span class="st">"target_compound_name"</span>, <span class="st">"score"</span>, <span class="st">"reverse_score"</span>,</span>
<span>                          <span class="st">"presence_ratio"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    spectrum_id target_spectrum_id    target_compound_name     score</span></span>
<span><span class="co">## 1         sp_1               &lt;NA&gt;                    &lt;NA&gt;        NA</span></span>
<span><span class="co">## 2         sp_2           LU056604             Azaconazole 0.7869556</span></span>
<span><span class="co">## 3         sp_2           LU056603             Azaconazole 0.8855473</span></span>
<span><span class="co">## 4         sp_2           LU056602             Azaconazole 0.7234894</span></span>
<span><span class="co">## 5         sp_2           LU056605             Azaconazole 0.7219942</span></span>
<span><span class="co">## 6         sp_3               &lt;NA&gt;                    &lt;NA&gt;        NA</span></span>
<span><span class="co">## 7         sp_4           KW108103 triphenylphosphineoxide 0.7769746</span></span>
<span><span class="co">## 8         sp_4           KW108102 triphenylphosphineoxide 0.7577286</span></span>
<span><span class="co">## 9         sp_5               &lt;NA&gt;                    &lt;NA&gt;        NA</span></span>
<span><span class="co">## 10        sp_6           SM839501            Dimethachlor 0.7433718</span></span>
<span><span class="co">## 11        sp_6           EA070705            Dimethachlor 0.7019807</span></span>
<span><span class="co">## 12        sp_6           EA070711            Dimethachlor 0.7081274</span></span>
<span><span class="co">## 13        sp_7               &lt;NA&gt;                    &lt;NA&gt;        NA</span></span>
<span><span class="co">## 14        sp_8           SM839501            Dimethachlor 0.7320465</span></span>
<span><span class="co">## 15        sp_8           EA070705            Dimethachlor 0.8106258</span></span>
<span><span class="co">## 16        sp_8           EA070710            Dimethachlor 0.7290458</span></span>
<span><span class="co">## 17        sp_8           EA070711            Dimethachlor 0.8168876</span></span>
<span><span class="co">## 18        sp_8           EA070704            Dimethachlor 0.7247800</span></span>
<span><span class="co">## 19        sp_9           KW108103 triphenylphosphineoxide 0.7412586</span></span>
<span><span class="co">## 20        sp_9           KW108102 triphenylphosphineoxide 0.7198787</span></span>
<span><span class="co">## 21       sp_10               &lt;NA&gt;                    &lt;NA&gt;        NA</span></span>
<span><span class="co">## 22       sp_11               &lt;NA&gt;                    &lt;NA&gt;        NA</span></span>
<span><span class="co">## 23       sp_12               &lt;NA&gt;                    &lt;NA&gt;        NA</span></span>
<span><span class="co">## 24       sp_13               &lt;NA&gt;                    &lt;NA&gt;        NA</span></span>
<span><span class="co">##    reverse_score presence_ratio</span></span>
<span><span class="co">## 1             NA             NA</span></span>
<span><span class="co">## 2      0.8764394      0.5833333</span></span>
<span><span class="co">## 3      0.9239592      0.6250000</span></span>
<span><span class="co">## 4      0.7573541      0.6250000</span></span>
<span><span class="co">## 5      0.9519647      0.4285714</span></span>
<span><span class="co">## 6             NA             NA</span></span>
<span><span class="co">## 7      0.9025051      0.7500000</span></span>
<span><span class="co">## 8      0.9164348      0.5000000</span></span>
<span><span class="co">## 9             NA             NA</span></span>
<span><span class="co">## 10     0.8915201      0.5000000</span></span>
<span><span class="co">## 11     0.8687003      0.3333333</span></span>
<span><span class="co">## 12     0.8687472      0.3703704</span></span>
<span><span class="co">## 13            NA             NA</span></span>
<span><span class="co">## 14     0.8444402      0.5000000</span></span>
<span><span class="co">## 15     0.9267965      0.5000000</span></span>
<span><span class="co">## 16     0.8765496      0.7500000</span></span>
<span><span class="co">## 17     0.9236674      0.4814815</span></span>
<span><span class="co">## 18     0.8714208      0.8571429</span></span>
<span><span class="co">## 19     0.8743130      0.7500000</span></span>
<span><span class="co">## 20     0.8937751      0.5000000</span></span>
<span><span class="co">## 21            NA             NA</span></span>
<span><span class="co">## 22            NA             NA</span></span>
<span><span class="co">## 23            NA             NA</span></span>
<span><span class="co">## 24            NA             NA</span></span></code></pre>
<p>In these examples we matched query spectra only to target spectra if
their precursor m/z is ~ equal and reported only matches with a
similarity higher than 0.7. <code>CompareSpectraParam</code>, through
its parameter <code>THRESHFUN</code> would however also allow other
types of analyses. We could for example also report the <em>best
matching</em> target spectrum for each query spectrum, independently of
whether the similarity score is higher than a certain threshold. Below
we perform such an analysis defining a <code>THRESHFUN</code> that
selects always the best match.</p>
<div class="sourceCode" id="cb98"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">select_top_match</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/which.min.html" class="external-link">which.max</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">csp2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CompareSpectraParam.html">CompareSpectraParam</a></span><span class="op">(</span>ppm <span class="op">=</span> <span class="fl">10</span>, requirePrecursor <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                            THRESHFUN <span class="op">=</span> <span class="va">select_top_match</span><span class="op">)</span></span>
<span><span class="va">mtches</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/matchSpectra.html">matchSpectra</a></span><span class="op">(</span><span class="va">pest_ms2</span>, <span class="va">minimb</span>, param <span class="op">=</span> <span class="va">csp2</span><span class="op">)</span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">spectraData</a></span><span class="op">(</span><span class="va">mtches</span>, columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"spectrum_id"</span>, <span class="st">"target_spectrum_id"</span>,</span>
<span>                                       <span class="st">"target_compound_name"</span>, <span class="st">"score"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    spectrum_id target_spectrum_id                   target_compound_name</span></span>
<span><span class="co">## 1         sp_1           SM839603                             Flufenacet</span></span>
<span><span class="co">## 2         sp_2           LU056603                            Azaconazole</span></span>
<span><span class="co">## 3         sp_3           SM839501                           Dimethachlor</span></span>
<span><span class="co">## 4         sp_4           KW108103                triphenylphosphineoxide</span></span>
<span><span class="co">## 5         sp_5           LU100202        2,2'-(Tetradecylimino)diethanol</span></span>
<span><span class="co">## 6         sp_6           SM839501                           Dimethachlor</span></span>
<span><span class="co">## 7         sp_7           RP005503              Glycoursodeoxycholic acid</span></span>
<span><span class="co">## 8         sp_8           EA070711                           Dimethachlor</span></span>
<span><span class="co">## 9         sp_9           KW108103                triphenylphosphineoxide</span></span>
<span><span class="co">## 10       sp_10           JP006901                  1-PHENYLETHYL ACETATE</span></span>
<span><span class="co">## 11       sp_11           EA070711                           Dimethachlor</span></span>
<span><span class="co">## 12       sp_12           EA070705                           Dimethachlor</span></span>
<span><span class="co">## 13       sp_13           LU101704 2-Ethylhexyl 4-(dimethylamino)benzoate</span></span>
<span><span class="co">##           score</span></span>
<span><span class="co">## 1  0.000000e+00</span></span>
<span><span class="co">## 2  8.855473e-01</span></span>
<span><span class="co">## 3  6.313687e-01</span></span>
<span><span class="co">## 4  7.769746e-01</span></span>
<span><span class="co">## 5  1.772117e-05</span></span>
<span><span class="co">## 6  7.433718e-01</span></span>
<span><span class="co">## 7  1.906998e-03</span></span>
<span><span class="co">## 8  8.168876e-01</span></span>
<span><span class="co">## 9  7.412586e-01</span></span>
<span><span class="co">## 10 4.085289e-04</span></span>
<span><span class="co">## 11 4.323403e-01</span></span>
<span><span class="co">## 12 3.469648e-03</span></span>
<span><span class="co">## 13 7.612480e-06</span></span></code></pre>
<p>Note that this whole example would work on any <code>Spectra</code>
object with MS2 spectra. Such objects could also be extracted from an
<code>xcms</code>-based LC-MS/MS data analysis with the
<code>chromPeaksSpectra()</code> or <code>featureSpectra()</code>
functions from the <em><a href="https://bioconductor.org/packages/3.22/xcms" class="external-link">xcms</a></em>
package. Note also that retention times could in addition be considered
in the matching by selecting a non-infinite value for the
<code>toleranceRt</code> of any of the parameter classes. By default
this uses the retention times provided by the query and target spectra
(i.e. spectra variable <code>"rtime"</code>) but it is also possible to
specify any other spectra variable for the additional retention time
matching (e.g. retention indices instead of times) using the
<code>rtColname</code> parameter of the <code>matchSpectra(0</code>
function (see <code><a href="../reference/matchSpectra.html">?matchSpectra</a></code> help page for more
information).</p>
<p>Matches can be also further validated using an interactive Shiny app
by calling <code><a href="../reference/validateMatchedSpectra.html">validateMatchedSpectra()</a></code> on the
<code>MatchedSpectra</code> object. Individual matches can be set to
TRUE or FALSE in this app. By closing the app via the Save &amp; Close
button a filtered <code>MatchedSpectra</code> is returned, containing
only matches manually validated.</p>
<div class="section level4">
<h4 id="query-against-multiple-reference-databases">Query against multiple reference databases<a class="anchor" aria-label="anchor" href="#query-against-multiple-reference-databases"></a>
</h4>
<p>Getting access to reference spectra can sometimes be a little
cumbersome since it might involve lookup and download of specific
resources or eventual conversion of these into a format suitable for
import. <code>MetaboAnnotation</code> provides <em>compound annotation
sources</em> to simplify this process. These annotation source objects
represent references (links) to annotation resources and can be used in
the <code><a href="../reference/matchSpectra.html">matchSpectra()</a></code> call to define the targed/reference
spectra. The annotation source object takes then care, upon request, of
retrieving the annotation data or connecting to the annotation
resources.</p>
<p>Also, <em>compound annotation sources</em> can be combined to allow
matching query spectra against multiple reference libraries in a single
call.</p>
<p>At present <code>MetaboAnnotation</code> supports the following types
of <em>compound annotation sources</em> (i.e. objects extending
<code>CompAnnotationSource</code>):</p>
<ul>
<li><p>Annotation resources that provide their data as a
<code>CompDb</code> database (defined by the <em><a href="https://bioconductor.org/packages/3.22/CompoundDb" class="external-link">CompoundDb</a></em>)
package. These are supported by the <code>CompDbSource</code>
class.</p></li>
<li><p>Annotation resources for which a dedicated <code>MsBackend</code>
backend is available hence supporting to access the data <em>via</em> a
<code>Spectra</code> object. These are supported by the
<code>SpectraDbSource</code> class.</p></li>
</ul>
<p>Various helper functions, specific for the annotation resource, are
available to create such annotation source objects:</p>
<ul>
<li><p><code>CompDbSource</code>: creates a compound annotation source
object from the provided <code>CompDb</code> SQLite data base file. This
function can be used to integrate an existing (locally available)
<code>CompDb</code> annotation database into an annotation
workflow.</p></li>
<li><p><code>MassBankSource</code>: creates a annotation source object
for a specific MassBank release. The desired release can be specified
with the <code>release</code> parameter
(e.g. <code>release = "2021.03"</code> or
<code>release = "2022.06"</code>). The function will then download the
respective annotation database from Bioconductor’s <em><a href="https://bioconductor.org/packages/3.22/AnnotationHub" class="external-link">AnnotationHub</a></em>.</p></li>
</ul>
<p>In the example below we create a annotation source for MassBank
release <em>2022.06</em>. This call will lookup the requested version in
Biocondutor’s (online) <code>AnnotationHub</code> and download the data.
Subsequent requests for the same annotation resource will load the
locally cached version instead. Upcoming MassBank database releases will
be added to <code>AnnotationHub</code> after their official release and
all previous releases will be available as well.</p>
<div class="sourceCode" id="cb100"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mbank</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CompDbSource.html">MassBankSource</a></span><span class="op">(</span><span class="st">"2022.06"</span><span class="op">)</span></span>
<span><span class="va">mbank</span></span></code></pre></div>
<pre><code><span><span class="co">## Object of class CompDbSource </span></span>
<span><span class="co">## Metadata information:</span></span>
<span><span class="co">##   - source: MassBank</span></span>
<span><span class="co">##   - url: https://massbank.eu/MassBank/</span></span>
<span><span class="co">##   - source_version: 2022.06</span></span>
<span><span class="co">##   - source_date: 2022-06-21</span></span>
<span><span class="co">##   - organism: NA</span></span>
<span><span class="co">##   - db_creation_date: Tue Aug 30 06:51:39 2022</span></span>
<span><span class="co">##   - supporting_package: CompoundDb</span></span>
<span><span class="co">##   - supporting_object: CompDb</span></span></code></pre>
<p>We can now use that annotation source object in the
<code><a href="../reference/matchSpectra.html">matchSpectra()</a></code> call to compare the experimental spectra
from the previous examples against that release of MassBank.</p>
<div class="sourceCode" id="cb102"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/matchSpectra.html">matchSpectra</a></span><span class="op">(</span></span>
<span>    <span class="va">pest_ms2</span>, <span class="va">mbank</span>,</span>
<span>    param <span class="op">=</span> <span class="fu"><a href="../reference/CompareSpectraParam.html">CompareSpectraParam</a></span><span class="op">(</span>requirePrecursor <span class="op">=</span> <span class="cn">TRUE</span>, ppm <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 'MsBackendCompDb' does not support parallel processing. Switching to serial processing.</span></span>
<span><span class="co">## 'MsBackendCompDb' does not support parallel processing. Switching to serial processing.</span></span>
<span><span class="co">## 'MsBackendCompDb' does not support parallel processing. Switching to serial processing.</span></span>
<span><span class="co">## 'MsBackendCompDb' does not support parallel processing. Switching to serial processing.</span></span>
<span><span class="co">## 'MsBackendCompDb' does not support parallel processing. Switching to serial processing.</span></span>
<span><span class="co">## 'MsBackendCompDb' does not support parallel processing. Switching to serial processing.</span></span>
<span><span class="co">## 'MsBackendCompDb' does not support parallel processing. Switching to serial processing.</span></span>
<span><span class="co">## 'MsBackendCompDb' does not support parallel processing. Switching to serial processing.</span></span>
<span><span class="co">## 'MsBackendCompDb' does not support parallel processing. Switching to serial processing.</span></span>
<span><span class="co">## 'MsBackendCompDb' does not support parallel processing. Switching to serial processing.</span></span>
<span><span class="co">## 'MsBackendCompDb' does not support parallel processing. Switching to serial processing.</span></span></code></pre>
<div class="sourceCode" id="cb104"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res</span></span></code></pre></div>
<pre><code><span><span class="co">## Object of class MatchedSpectra </span></span>
<span><span class="co">## Total number of matches: 14 </span></span>
<span><span class="co">## Number of query objects: 13 (6 matched)</span></span>
<span><span class="co">## Number of target objects: 10 (10 matched)</span></span></code></pre>
<p>The result object contains only the matching fragment spectra from
the reference database.</p>
<div class="sourceCode" id="cb106"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/Matched.html">target</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## MSn data (Spectra) with 10 spectra in a MsBackendDataFrame backend:</span></span>
<span><span class="co">##      msLevel     rtime scanIndex</span></span>
<span><span class="co">##    &lt;integer&gt; &lt;numeric&gt; &lt;integer&gt;</span></span>
<span><span class="co">## 1          2        NA        NA</span></span>
<span><span class="co">## 2          2        NA        NA</span></span>
<span><span class="co">## 3          2        NA        NA</span></span>
<span><span class="co">## 4          2        NA        NA</span></span>
<span><span class="co">## 5          2        NA        NA</span></span>
<span><span class="co">## 6          2        NA        NA</span></span>
<span><span class="co">## 7          2        NA        NA</span></span>
<span><span class="co">## 8          2        NA        NA</span></span>
<span><span class="co">## 9          2        NA        NA</span></span>
<span><span class="co">## 10         2        NA        NA</span></span>
<span><span class="co">##  ... 46 more variables/columns.</span></span>
<span><span class="co">## Processing:</span></span>
<span><span class="co">##  Switch backend from MsBackendCompDb to MsBackendDataFrame [Tue Oct 14 08:02:35 2025]</span></span></code></pre>
<p>And the names of the compounds with matching fragment spectra.</p>
<div class="sourceCode" id="cb108"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/Matched.html">matchedData</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span><span class="op">$</span><span class="va">target_name</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] NA                         "Azaconazole"             </span></span>
<span><span class="co">##  [3] "Azaconazole"              "Azaconazole"             </span></span>
<span><span class="co">##  [5] "Azaconazole"              NA                        </span></span>
<span><span class="co">##  [7] "triphenylphosphineoxide"  "triphenylphosphineoxide" </span></span>
<span><span class="co">##  [9] "Triphenylphosphine oxide" "N,N-Dimethyldodecylamine"</span></span>
<span><span class="co">## [11] "Dimethachlor"             NA                        </span></span>
<span><span class="co">## [13] "Dimethachlor"             "Triphenylphosphine oxide"</span></span>
<span><span class="co">## [15] "triphenylphosphineoxide"  "triphenylphosphineoxide" </span></span>
<span><span class="co">## [17] "Triphenylphosphine oxide" NA                        </span></span>
<span><span class="co">## [19] NA                         NA                        </span></span>
<span><span class="co">## [21] NA</span></span></code></pre>
</div>
<div class="section level4">
<h4 id="finding-ms2-spectra-for-selected-mz-and-retention-times">Finding MS2 spectra for selected m/z and retention times<a class="anchor" aria-label="anchor" href="#finding-ms2-spectra-for-selected-mz-and-retention-times"></a>
</h4>
<p>Sometimes it is needed to identify fragment spectra in a
<code>Spectra</code> object for selected (precursor) m/z values and
retention times. An example would be if compound quantification was
performed with a LC-MS run and in a second LC-MS/MS run (with the same
chromatographic setup) fragment spectra of the same samples were
generated. From the first LC-MS data set <em>features</em> (or
chromatographic peaks) would be identified for which it would be
necessary to retrieve fragment spectra matching the m/z and retention
times of these from the second, LC-MS/MS data set (assuming that no big
retention time shifts between the measurement runs are expected). To
illustrate this, we below first define a <code>data.frame</code> that
should represent a feature table such as defined by an analysis with the
<em><a href="https://bioconductor.org/packages/3.22/xcms" class="external-link">xcms</a></em>
package.</p>
<div class="sourceCode" id="cb110"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    feature_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"FT001"</span>, <span class="st">"FT002"</span>, <span class="st">"FT003"</span>, <span class="st">"FT004"</span>, <span class="st">"FT005"</span><span class="op">)</span>,</span>
<span>    mzmed <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">313.43</span>, <span class="fl">256.11</span>, <span class="fl">224.08</span>, <span class="fl">159.22</span>, <span class="fl">224.08</span><span class="op">)</span>,</span>
<span>    rtmed <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">38.5</span>, <span class="fl">379.1</span>, <span class="fl">168.2</span>, <span class="fl">48.2</span>, <span class="fl">381.1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We next match the features from this data frame against the
<code>Spectra</code> object using an <code>MzRtParam</code> to identify
fragment spectra with their precursor m/z and retention times matching
(with some tolerance) the values from the features.</p>
<div class="sourceCode" id="cb111"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fts_mtch</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/matchValues.html">matchValues</a></span><span class="op">(</span><span class="va">fts</span>, <span class="va">pest_ms2</span>, <span class="fu"><a href="../reference/matchValues.html">MzRtParam</a></span><span class="op">(</span>ppm <span class="op">=</span> <span class="fl">50</span>, toleranceRt <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>,</span>
<span>                        mzColname <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"mzmed"</span>, <span class="st">"precursorMz"</span><span class="op">)</span>,</span>
<span>                        rtColname <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"rtmed"</span>, <span class="st">"rtime"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">fts_mtch</span></span></code></pre></div>
<pre><code><span><span class="co">## Object of class Matched </span></span>
<span><span class="co">## Total number of matches: 5 </span></span>
<span><span class="co">## Number of query objects: 5 (2 matched)</span></span>
<span><span class="co">## Number of target objects: 13 (5 matched)</span></span></code></pre>
<div class="sourceCode" id="cb113"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/Matched.html">whichQuery</a></span><span class="op">(</span><span class="va">fts_mtch</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 2 5</span></span></code></pre>
<p>Thus, we found fragment spectra matching the m/z and retention times
for the 2nd and 5th feature. To extract the <code>Spectra</code>
matching these features, it would be best to first reduce the object to
features with at least one matching fragment spectrum. The indices of
query elements (in our case features) with matches can be returned using
the <code><a href="../reference/Matched.html">whichQuery()</a></code> function. We use these below to subset our
matched result keeping only features for which matches were found:</p>
<div class="sourceCode" id="cb115"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fts_mtched</span> <span class="op">&lt;-</span> <span class="va">fts_mtch</span><span class="op">[</span><span class="fu"><a href="../reference/Matched.html">whichQuery</a></span><span class="op">(</span><span class="va">fts_mtch</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">fts_mtched</span></span></code></pre></div>
<pre><code><span><span class="co">## Object of class Matched </span></span>
<span><span class="co">## Total number of matches: 5 </span></span>
<span><span class="co">## Number of query objects: 2 (2 matched)</span></span>
<span><span class="co">## Number of target objects: 13 (5 matched)</span></span></code></pre>
<p>The feature IDs for the matched spectra can be extracted using:</p>
<div class="sourceCode" id="cb117"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fts_mtched</span><span class="op">$</span><span class="va">feature_id</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "FT002" "FT002" "FT002" "FT005" "FT005"</span></span></code></pre>
<p>We next need to extract the matching fragment spectra from the
<code>target</code> <code>Spectra</code> object. Here we use the
<code><a href="../reference/Matched.html">targetIndex()</a></code> function, that returns the indices of the
target spectra that were matched to the query.</p>
<div class="sourceCode" id="cb119"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/Matched.html">targetIndex</a></span><span class="op">(</span><span class="va">fts_mtched</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1]  3  6  8  7 11</span></span></code></pre>
<p>We extract thus next the fragment spectra matching at least one
feature:</p>
<div class="sourceCode" id="cb121"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fts_ms2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Matched.html">target</a></span><span class="op">(</span><span class="va">fts_mtched</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="../reference/Matched.html">targetIndex</a></span><span class="op">(</span><span class="va">fts_mtched</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">fts_ms2</span></span></code></pre></div>
<pre><code><span><span class="co">## MSn data (Spectra) with 5 spectra in a MsBackendMzR backend:</span></span>
<span><span class="co">##     msLevel     rtime scanIndex</span></span>
<span><span class="co">##   &lt;integer&gt; &lt;numeric&gt; &lt;integer&gt;</span></span>
<span><span class="co">## 1         2   377.609      3030</span></span>
<span><span class="co">## 2         2   378.539      3035</span></span>
<span><span class="co">## 3         2   378.869      3038</span></span>
<span><span class="co">## 4         2   378.779      3037</span></span>
<span><span class="co">## 5         2   380.059      3045</span></span>
<span><span class="co">##  ... 36 more variables/columns.</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## file(s):</span></span>
<span><span class="co">## PestMix1_DDA.mzML</span></span>
<span><span class="co">## Processing:</span></span>
<span><span class="co">##  Filter: select MS level(s) 2 [Tue Oct 14 08:02:28 2025]</span></span></code></pre>
<p>While we have now the spectra, we can’t relate them (yet) to the
features we used as <code>query</code>. Extracting the
<code>"feature_id"</code> column using the <code>$</code> function from
the the matched object would however return, for each match (since we
restricted the matched object to contain only features with matches) the
feature ID (provided in the original data frame). We can thus add this
information as an additional spectra variable to our
<code>Spectra</code> object:</p>
<div class="sourceCode" id="cb123"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fts_ms2</span><span class="op">$</span><span class="va">feature_id</span> <span class="op">&lt;-</span> <span class="va">fts_mtched</span><span class="op">$</span><span class="va">feature_id</span></span></code></pre></div>
<p>Be aware that extracting the <code>"feature_id"</code> column from
the matched object <strong>before</strong> restricting to features with
matches would also return the values for features for which no MS2
spectrum was found:</p>
<div class="sourceCode" id="cb124"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fts_mtch</span><span class="op">$</span><span class="va">feature_id</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "FT001" "FT002" "FT002" "FT002" "FT003" "FT004" "FT005" "FT005"</span></span></code></pre>
<p>Without the initial subsetting of the matched object to features with
at least one matching spectra, the extraction would be a bit more
complicated:</p>
<div class="sourceCode" id="cb126"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fts_ms2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Matched.html">target</a></span><span class="op">(</span><span class="va">fts_mtch</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="../reference/Matched.html">targetIndex</a></span><span class="op">(</span><span class="va">fts_mtch</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">fts_ms2</span><span class="op">$</span><span class="va">feature_id</span> <span class="op">&lt;-</span> <span class="fu">query</span><span class="op">(</span><span class="va">fts_mtch</span><span class="op">)</span><span class="op">$</span><span class="va">feature_id</span><span class="op">[</span><span class="fu"><a href="../reference/Matched.html">queryIndex</a></span><span class="op">(</span><span class="va">fts_mtch</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">fts_ms2</span><span class="op">$</span><span class="va">feature_id</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "FT002" "FT002" "FT002" "FT005" "FT005"</span></span></code></pre>
<p>This <code>Spectra</code> could next be used to match the fragment
spectra from the experiment to e.g. a reference database and with the
assigned spectra variable <code>"feature_id"</code> it would allow to
map the results back to the quantified feature matrix from the LC-MS
run.</p>
</div>
<div class="section level4">
<h4 id="performance-and-parallel-processing">Performance and parallel processing<a class="anchor" aria-label="anchor" href="#performance-and-parallel-processing"></a>
</h4>
<p>Pre-filtering the target spectra based on similar precursor m/z
(using <code>requirePrecursor = TRUE</code> generally speeds up the call
because a spectra comparison needs only to be performed on subsets of
target spectra. Performance of the <code><a href="../reference/matchSpectra.html">matchSpectra()</a></code> function
depends however also on the backend used for the query and target
<code>Spectra</code>. For some backends the peaks data (i.e. m/z and
intensity values) might not be already loaded into memory and hence
spectra comparisons might be slower because that data needs to be first
loaded. As an example, for <code>Spectra</code> objects, such as our
<code>pest_ms2</code> variable, that use the
<code>MsBackendMzR</code>backend, the peaks data needs to be loaded from
the raw data files before the spectra similarity scores can be
calculated. Changing the backend to an in-memory data representation
before <code><a href="../reference/matchSpectra.html">matchSpectra()</a></code> can thus improve the performance (at
the cost of a higher memory demand).</p>
<p>Below we change the backends of the <code>pest_ms2</code> and
<code>minimb</code> objects to <code>MsBackendMemory</code> which keeps
all data (spectra and peaks data) in memory and we compare the
performance against the originally used <code>MsBackendMzR</code> (for
<code>pest_ms2</code>) and <code>MsBackendDataFrame</code> (for
<code>minimb</code>).</p>
<div class="sourceCode" id="cb128"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pest_ms2_mem</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/backendInitialize.html" class="external-link">setBackend</a></span><span class="op">(</span><span class="va">pest_ms2</span>, <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/MsBackend.html" class="external-link">MsBackendMemory</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">minimb_mem</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/backendInitialize.html" class="external-link">setBackend</a></span><span class="op">(</span><span class="va">minimb</span>, <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/MsBackend.html" class="external-link">MsBackendMemory</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/joshuaulrich/microbenchmark/" class="external-link">microbenchmark</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">compareSpectra</a></span><span class="op">(</span><span class="va">pest_ms2</span>, <span class="va">minimb</span>, param <span class="op">=</span> <span class="va">csp</span><span class="op">)</span>,</span>
<span>               <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">compareSpectra</a></span><span class="op">(</span><span class="va">pest_ms2_mem</span>, <span class="va">minimb_mem</span>, param <span class="op">=</span> <span class="va">csp</span><span class="op">)</span>,</span>
<span>               times <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Unit: milliseconds</span></span>
<span><span class="co">##                                                   expr      min       lq</span></span>
<span><span class="co">##          compareSpectra(pest_ms2, minimb, param = csp) 46.98724 47.79666</span></span>
<span><span class="co">##  compareSpectra(pest_ms2_mem, minimb_mem, param = csp) 28.25619 28.37972</span></span>
<span><span class="co">##      mean   median       uq      max neval</span></span>
<span><span class="co">##  54.05896 47.94280 48.20879 79.35931     5</span></span>
<span><span class="co">##  31.17176 28.40164 29.24274 41.57851     5</span></span></code></pre>
<p>There is a considerable performance gain by using the
<code>MsBackendMemory</code> over the two other backends, that comes
however at the cost of a higher memory demand. Thus, for large data sets
(or reference libraries) this might not be an option. See also <a href="https://github.com/rformassspectrometry/MetaboAnnotation/issues/93" class="external-link">issue
#93</a> in the <code>MetaboAnnotation</code> github repository for more
benchmarks and information on performance of
<code><a href="../reference/matchSpectra.html">matchSpectra()</a></code>.</p>
<p>If for <code>target</code> a <code>Spectra</code> using a SQL
database-based backend is used (such as a
<code>MsBackendMassbankSql</code>, <code>MsBackendCompDb</code> or
<code>MsBackendSql</code>) and spectra matching is performed with
<code>requirePrecursorMz = TRUE</code>, simply <em>caching</em> the
precursor m/z values of all target spectra in memory improves the
performance of <code>matchSpectra</code> considerably. This can be
easily done with e.g.
<code>target_sps$precursorMz &lt;- precursorMz(target_sps)</code> where
<code>target_sps</code> is the <code>Spectra</code> object that uses one
of the above mentioned backends. With this call all precursor m/z values
will be cached within <code>target_sps</code> and any
<code>precursorMz(target_sps)</code> call (which is used by
<code><a href="../reference/matchSpectra.html">matchSpectra()</a></code> to select the candidate spectra against
which to compare a query spectrum) will not require a separate SQL
call.</p>
<p>Parallel processing can also improve performance, but might not be
possible for all backends. In particular, backends based on SQL
databases don’t allow parallel processing because the database
connection can not be shared across different processes.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="utility-functions">Utility functions<a class="anchor" aria-label="anchor" href="#utility-functions"></a>
</h2>
<p><em>MetaboAnnotation</em> provides also other utility functions not
directly related to the annotation process. These are presented in this
section.</p>
<div class="section level3">
<h3 id="creating-mixes-of-standard-compounds">Creating mixes of standard compounds<a class="anchor" aria-label="anchor" href="#creating-mixes-of-standard-compounds"></a>
</h3>
<p>The function <code><a href="../reference/createStandardMixes.html">createStandardMixes()</a></code> allows for grouping
of standard compounds with a minimum difference in m/z based on user
input.</p>
<div class="sourceCode" id="cb130"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/MetaboCoreUtils" class="external-link">MetaboCoreUtils</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level4">
<h4 id="input-format">Input format<a class="anchor" aria-label="anchor" href="#input-format"></a>
</h4>
<p>As an example here I will extract a list of a 100 standard compounds
with their formula from a tab delimited text file provided with the
package. Such files could also be imported from an xlsx sheet using the
<em>readxl</em> package.</p>
<div class="sourceCode" id="cb131"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">standard</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"Standard_list_example.txt"</span>,</span>
<span>                               package <span class="op">=</span> <span class="st">"MetaboAnnotation"</span><span class="op">)</span>,</span>
<span>                   header <span class="op">=</span> <span class="cn">TRUE</span>, sep <span class="op">=</span> <span class="st">"\t"</span>, quote <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span></code></pre></div>
<p>We will use functions from the MetaboCoreUtil package to get the mass
of each compounds and the m/z for the adducts wanted.</p>
<div class="sourceCode" id="cb132"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Calculate mass based on formula of compounds</span></span>
<span><span class="va">standard</span><span class="op">$</span><span class="va">mass</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MetaboCoreUtils/man/calculateMass.html" class="external-link">calculateMass</a></span><span class="op">(</span><span class="va">standard</span><span class="op">$</span><span class="va">formula</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' Create input for function</span></span>
<span><span class="co">#' Calculate charge for 2 adducts</span></span>
<span><span class="va">standard_charged</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MetaboCoreUtils/man/mass2mz.html" class="external-link">mass2mz</a></span><span class="op">(</span><span class="va">standard</span><span class="op">$</span><span class="va">mass</span>, adduct <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"[M+H]+"</span>, <span class="st">"[M+Na]+"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' have compounds names as rownames</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">standard_charged</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">standard</span><span class="op">[</span> , <span class="fl">1</span><span class="op">]</span></span>
<span></span>
<span><span class="co">#' ensure the input `x` is a matrix</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">is.matrix</a></span><span class="op">(</span><span class="va">standard_charged</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">standard_charged</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">standard_charged</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>The input table for the createStandardMixes should thus look like the
one shown below, i.e. should be a numeric matrix with each row
representing one compound. Columns are expected to contain m/z values
for different adducts of that compound. Importantly, the row names of
the matrix should represent the (unique) compound names (or any other
unique identifier for the compound).</p>
<div class="sourceCode" id="cb133"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">standard_charged</span></span></code></pre></div>
<pre><code><span><span class="co">##                                                         [M+H]+   [M+Na]+</span></span>
<span><span class="co">## 2-Acetylpyrazine                                     123.05529 145.03723</span></span>
<span><span class="co">## Guanosine 5′-diphosphate sodium sa                   444.03161 466.01355</span></span>
<span><span class="co">## Quinoline-4-carboxylic acid                          174.05495 196.03690</span></span>
<span><span class="co">## Heneicosanoic acid                                   327.32576 349.30770</span></span>
<span><span class="co">## Sudan III                                            353.13969 375.12163</span></span>
<span><span class="co">## Erythrosine B                                        836.66234 858.64429</span></span>
<span><span class="co">## Hypoxanthine                                         137.04579 159.02773</span></span>
<span><span class="co">## 2-Oxoadipic acid                                     161.04445 183.02639</span></span>
<span><span class="co">## N-Acetyl-L-cysteine                                  164.03759 186.01953</span></span>
<span><span class="co">## Carbamazepine                                        237.10224 259.08418</span></span>
<span><span class="co">## Famotidine                                           338.05221 360.03416</span></span>
<span><span class="co">## "trans-2-Butene-1,4-dicarboxylic acid"               145.04953 167.03148</span></span>
<span><span class="co">## DL-p-Hydroxyphenyllactic acid                        183.06518 205.04713</span></span>
<span><span class="co">## "Malachite Green, Oxalate"                           365.17790 387.15985</span></span>
<span><span class="co">## Brucine sulfate heptahydrate                         395.19653 417.17848</span></span>
<span><span class="co">## Uric acid                                            169.03562 191.01756</span></span>
<span><span class="co">## Glycocholic acid hydrate                             466.31631 488.29826</span></span>
<span><span class="co">## DL-4-Hydroxy-3-methoxymandelic acid                  199.06010 221.04204</span></span>
<span><span class="co">## Phosphorylcholine chloride calcium salt tetrahydrate 185.08115 207.06309</span></span>
<span><span class="co">## Imidazole                                             69.04472  91.02667</span></span>
<span><span class="co">## Indole                                               118.06513 140.04707</span></span>
<span><span class="co">## Perindopril erbumine                                 369.23840 391.22034</span></span>
<span><span class="co">## Folinic acid calcium salt hydrate                    474.17317 496.15512</span></span>
<span><span class="co">## "Tauroursodeoxycholic acid, Na salt"                 500.30404 522.28598</span></span>
<span><span class="co">## Glycyl-L-leucine                                     189.12337 211.10531</span></span>
<span><span class="co">## Carotene                                             537.44548 559.42742</span></span>
<span><span class="co">## 2-Methylsuccinic acid                                133.04953 155.03148</span></span>
<span><span class="co">## DL-m-Tyrosine                                        182.08117 204.06311</span></span>
<span><span class="co">## Ursodeoxycholic acid                                 393.29994 415.28188</span></span>
<span><span class="co">## N-Acetyl-L-alanine                                   132.06552 154.04746</span></span>
<span><span class="co">## 3-Hydroxybenzyl alcohol                              125.05971 147.04165</span></span>
<span><span class="co">## 2-Hydroxy-4-(methylthio)butyric acid calcium salt    151.04234 173.02429</span></span>
<span><span class="co">## Myrcene                                              137.13248 159.11442</span></span>
<span><span class="co">## "3,4-Dihydroxybenzeneacetic acid"                    169.04953 191.03148</span></span>
<span><span class="co">## Deoxycholic acid                                     393.29994 415.28188</span></span>
<span><span class="co">## 2-Aminobenzenesulfonic acid                          174.02194 196.00388</span></span>
<span><span class="co">## Indole-3-acetamide                                   175.08659 197.06853</span></span>
<span><span class="co">## L-Glutathione reduced                                308.09108 330.07303</span></span>
<span><span class="co">## (±)-3-Methyl-2-oxovaleric acid sodium sal            131.07027 153.05221</span></span>
<span><span class="co">## Lithocholic acid                                     377.30502 399.28697</span></span>
<span><span class="co">## Chenodeoxycholic acid sodium salt                    393.29994 415.28188</span></span>
<span><span class="co">## D-Allose                                             181.07066 203.05261</span></span>
<span><span class="co">## Solvent Blue 35                                      351.20670 373.18865</span></span>
<span><span class="co">## Tetradecanedioic acid                                259.19039 281.17233</span></span>
<span><span class="co">## Food Yellow 3                                        409.01587 430.99781</span></span>
<span><span class="co">## L-Homocitrulline                                     190.11862 212.10056</span></span>
<span><span class="co">## 3-Methylxanthine                                     167.05635 189.03830</span></span>
<span><span class="co">## Acid Yellow 36                                       354.09069 376.07263</span></span>
<span><span class="co">## L-Arabitol                                           153.07575 175.05769</span></span>
<span><span class="co">## Sodium phytate hydrate                               660.86865 682.85059</span></span>
<span><span class="co">## Phosphoserine                                        186.01620 207.99814</span></span>
<span><span class="co">## Deoxy-D-glucose                                      165.07575 187.05769</span></span>
<span><span class="co">## Alanine methyl ester hydrochloride                   104.07060 126.05255</span></span>
<span><span class="co">## Phenylac-Gly-OH                                      194.08117 216.06311</span></span>
<span><span class="co">## NADPH sodium salt                                    746.09838 768.08032</span></span>
<span><span class="co">## Pyridoxine HCl                                       170.08117 192.06311</span></span>
<span><span class="co">## L-Malic ac                                           135.02880 157.01074</span></span>
<span><span class="co">## Uracil                                               113.03455 135.01650</span></span>
<span><span class="co">## Adenosine                                            268.10403 290.08597</span></span>
<span><span class="co">## L-Carnitine inner salt                               162.11247 184.09441</span></span>
<span><span class="co">## Acetyl-L-glutamin                                    189.08698 211.06893</span></span>
<span><span class="co">## Aminobutyric acid                                    104.07060 126.05255</span></span>
<span><span class="co">## Ortho-Hydroxyphenylacetic acid                       153.05462 175.03656</span></span>
<span><span class="co">## Riboflavin                                           377.14556 399.12750</span></span>
<span><span class="co">## Diaminobutane dihydrochloride                         89.10732 111.08927</span></span>
<span><span class="co">## Sarcosine                                             90.05495 112.03690</span></span>
<span><span class="co">## L-Carnosine                                          227.11387 249.09581</span></span>
<span><span class="co">## Methylmalonic acid                                   119.03388 141.01583</span></span>
<span><span class="co">## L-Pyroglutamic acid                                  130.04987 152.03181</span></span>
<span><span class="co">## Rhodamine B                                          444.24074 466.22269</span></span>
<span><span class="co">## Indigo Carmine                                       422.99513 444.97708</span></span>
<span><span class="co">## Diaminopropionic acid monohydrochloride              105.06585 127.04780</span></span>
<span><span class="co">## Dimethylbenzimidazole                                147.09167 169.07362</span></span>
<span><span class="co">## N-Acetyl-L-aspartic acid                             176.05535 198.03729</span></span>
<span><span class="co">## Thiamine hydrochloride hydrate                       266.11958 288.10153</span></span>
<span><span class="co">## Taurine                                              126.02194 148.00388</span></span>
<span><span class="co">## Maleic acid                                          117.01823 139.00018</span></span>
<span><span class="co">## O-Acetyl-L-carnitine HCl                             204.12303 226.10498</span></span>
<span><span class="co">## N-Acetyl-D-galactosamine                             222.09721 244.07916</span></span>
<span><span class="co">## Citric acid                                          193.03428 215.01622</span></span>
<span><span class="co">## Dimethylglycine hydrochloride                        104.07060 126.05255</span></span>
<span><span class="co">## Erioglaucine disodium salt                           750.17339 772.15534</span></span>
<span><span class="co">## Sebacic acid                                         203.12779 225.10973</span></span>
<span><span class="co">## Stearic acid                                         285.27881 307.26075</span></span>
<span><span class="co">## L-Arginine                                           175.11895 197.10090</span></span>
<span><span class="co">## 2'-Deoxyuridine                                      229.08190 251.06384</span></span>
<span><span class="co">## Maltotriose                                          505.17631 527.15825</span></span>
<span><span class="co">## dimethyl-L-Valine                                    146.11755 168.09950</span></span>
<span><span class="co">## Acetylphenothiazine                                  242.06341 264.04535</span></span>
<span><span class="co">## Methoxybenzoic acid                                  153.05462 175.03656</span></span>
<span><span class="co">## Metyrosine                                           196.09682 218.07876</span></span>
<span><span class="co">## Rhein                                                285.03936 307.02131</span></span>
<span><span class="co">## N6-Methyladenine                                     150.07742 172.05937</span></span>
<span><span class="co">## Hydroxybenzoic acid                                  139.03897 161.02091</span></span>
<span><span class="co">## Sodium D-gluconate                                   197.06558 219.04752</span></span>
<span><span class="co">## L-Threonic acid Calcium Salt                         137.04445 159.02639</span></span>
<span><span class="co">## Methyl 3-aminopyrazine-2-carboxylate                 154.06110 176.04305</span></span>
<span><span class="co">## DL-α-Lipoamid                                        206.06678 228.04873</span></span>
<span><span class="co">## Lauric acid                                          201.18491 223.16685</span></span>
<span><span class="co">## Nicotinamide mononucleotide                          336.07170 358.05365</span></span></code></pre>
</div>
<div class="section level4">
<h4 id="using-the-function">Using the function<a class="anchor" aria-label="anchor" href="#using-the-function"></a>
</h4>
<p>The <code><a href="../reference/createStandardMixes.html">createStandardMixes()</a></code> function organizes given
compounds in such a way that each compound is placed in a group where
all ions (adducts) have a m/z difference exceeding a user-defined
threshold (default: <code>min_diff = 2</code>). In this initial example,
we aim to group only a subset of our compound list and execute the
function with default parameters:</p>
<div class="sourceCode" id="cb135"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">group_no_randomization</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/createStandardMixes.html">createStandardMixes</a></span><span class="op">(</span><span class="va">standard_charged</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">20</span>,<span class="op">]</span><span class="op">)</span></span>
<span><span class="va">group_no_randomization</span></span></code></pre></div>
<pre><code><span><span class="co">##                                                         [M+H]+   [M+Na]+ group</span></span>
<span><span class="co">## 2-Acetylpyrazine                                     123.05529 145.03723     1</span></span>
<span><span class="co">## Guanosine 5′-diphosphate sodium sa                   444.03161 466.01355     1</span></span>
<span><span class="co">## Quinoline-4-carboxylic acid                          174.05495 196.03690     1</span></span>
<span><span class="co">## Heneicosanoic acid                                   327.32576 349.30770     1</span></span>
<span><span class="co">## Sudan III                                            353.13969 375.12163     1</span></span>
<span><span class="co">## Erythrosine B                                        836.66234 858.64429     1</span></span>
<span><span class="co">## Hypoxanthine                                         137.04579 159.02773     1</span></span>
<span><span class="co">## 2-Oxoadipic acid                                     161.04445 183.02639     1</span></span>
<span><span class="co">## N-Acetyl-L-cysteine                                  164.03759 186.01953     1</span></span>
<span><span class="co">## Carbamazepine                                        237.10224 259.08418     1</span></span>
<span><span class="co">## Famotidine                                           338.05221 360.03416     2</span></span>
<span><span class="co">## "trans-2-Butene-1,4-dicarboxylic acid"               145.04953 167.03148     2</span></span>
<span><span class="co">## DL-p-Hydroxyphenyllactic acid                        183.06518 205.04713     2</span></span>
<span><span class="co">## "Malachite Green, Oxalate"                           365.17790 387.15985     2</span></span>
<span><span class="co">## Brucine sulfate heptahydrate                         395.19653 417.17848     2</span></span>
<span><span class="co">## Uric acid                                            169.03562 191.01756     2</span></span>
<span><span class="co">## Glycocholic acid hydrate                             466.31631 488.29826     2</span></span>
<span><span class="co">## DL-4-Hydroxy-3-methoxymandelic acid                  199.06010 221.04204     2</span></span>
<span><span class="co">## Phosphorylcholine chloride calcium salt tetrahydrate 185.08115 207.06309     2</span></span>
<span><span class="co">## Imidazole                                             69.04472  91.02667     2</span></span></code></pre>
<p>Let’s see the number of compounds per group:</p>
<div class="sourceCode" id="cb137"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">group_no_randomization</span><span class="op">$</span><span class="va">group</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##  1  2 </span></span>
<span><span class="co">## 10 10</span></span></code></pre>
<p>The grouping here worked perfectly, but let’s now use the entire
compound list and run with the default parameter again:</p>
<div class="sourceCode" id="cb139"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">group_no_randomization</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/createStandardMixes.html">createStandardMixes</a></span><span class="op">(</span><span class="va">standard_charged</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">group_no_randomization</span><span class="op">$</span><span class="va">group</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##  1  2  3  4  5  6  7  8  9 10 11 </span></span>
<span><span class="co">## 10 10 10 10 10 10 10 10 10  7  3</span></span></code></pre>
<p>This time we can see that the grouping is less ideal. In this case we
can switch the <code>iterativeRandomization = TRUE</code>.</p>
<div class="sourceCode" id="cb141"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">group_with_ramdomization</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/createStandardMixes.html">createStandardMixes</a></span><span class="op">(</span><span class="va">standard_charged</span>,</span>
<span>                                                iterativeRandomization <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">group_with_ramdomization</span><span class="op">$</span><span class="va">group</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##  1  2  3  4  5  6  7  8  9 10 </span></span>
<span><span class="co">## 10 10 10 10 10 10 10 10 10 10</span></span></code></pre>
<p>Changing <code>iterativeRandomization =</code> from the default
<code>FALSE</code> to <code>TRUE</code> enables the randomization of
input <code>x</code> rows until it fits the <code>min_nstd</code>
parameter. If the list of compounds is very long or the requirement is
hard to fit, this function can take a bit longer if
<code>iterativeRandomization =</code> is set to <code>TRUE.</code></p>
<p>What if we want groups of a maximum of 20 and a minimum of 15
compounds, and with a minimum difference of 2 m/z between compounds of
the same group? If you want to know more about the parameters of this
function, look at <code><a href="../reference/createStandardMixes.html">?createStandardMixes</a></code>.</p>
<div class="sourceCode" id="cb143"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">group_with_ramdomization</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/createStandardMixes.html">createStandardMixes</a></span><span class="op">(</span><span class="va">standard_charged</span>,</span>
<span>                                                max_nstd <span class="op">=</span> <span class="fl">15</span>,</span>
<span>                                                min_nstd <span class="op">=</span> <span class="fl">10</span>,</span>
<span>                                                min_diff <span class="op">=</span> <span class="fl">2</span>,</span>
<span>                                                iterativeRandomization <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">group_with_ramdomization</span><span class="op">$</span><span class="va">group</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##  1  2  3  4  5  6  7 </span></span>
<span><span class="co">## 15 15 15 15 15 15 10</span></span></code></pre>
<p>Great ! these groups look good; we can now export. As the function
already returns a <code>data.frame</code>, you can directly save is as
an Excel file using <code>write_xlsx()</code> from the <em>writexl</em>
R package or as below in text format that can also be open in Excel.</p>
<div class="sourceCode" id="cb145"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/write.table.html" class="external-link">write.table</a></span><span class="op">(</span><span class="va">group_with_ramdomization</span>,</span>
<span>           file <span class="op">=</span> <span class="st">"standard_mixes.txt"</span>, sep <span class="op">=</span> <span class="st">"\t"</span>, quote <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
</div>
<div class="section level2">
<h2 class="unnumbered" id="session-information">Session information<a class="anchor" aria-label="anchor" href="#session-information"></a>
</h2>
<pre><code><span><span class="co">## R version 4.5.1 (2025-06-13)</span></span>
<span><span class="co">## Platform: x86_64-pc-linux-gnu</span></span>
<span><span class="co">## Running under: Ubuntu 24.04.3 LTS</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Matrix products: default</span></span>
<span><span class="co">## BLAS:   /usr/lib/x86_64-linux-gnu/openblas-pthread/libblas.so.3 </span></span>
<span><span class="co">## LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.26.so;  LAPACK version 3.12.0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## locale:</span></span>
<span><span class="co">##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              </span></span>
<span><span class="co">##  [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    </span></span>
<span><span class="co">##  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   </span></span>
<span><span class="co">##  [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 </span></span>
<span><span class="co">##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            </span></span>
<span><span class="co">## [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## time zone: UTC</span></span>
<span><span class="co">## tzcode source: system (glibc)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## attached base packages:</span></span>
<span><span class="co">## [1] stats4    stats     graphics  grDevices utils     datasets  methods  </span></span>
<span><span class="co">## [8] base     </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## other attached packages:</span></span>
<span><span class="co">##  [1] MetaboCoreUtils_1.17.1      microbenchmark_1.5.0       </span></span>
<span><span class="co">##  [3] msdata_0.49.0               QFeatures_1.19.2           </span></span>
<span><span class="co">##  [5] MultiAssayExperiment_1.35.9 SummarizedExperiment_1.39.2</span></span>
<span><span class="co">##  [7] Biobase_2.69.1              GenomicRanges_1.61.5       </span></span>
<span><span class="co">##  [9] Seqinfo_0.99.2              IRanges_2.43.5             </span></span>
<span><span class="co">## [11] MatrixGenerics_1.21.0       matrixStats_1.5.0          </span></span>
<span><span class="co">## [13] Spectra_1.19.9              BiocParallel_1.43.4        </span></span>
<span><span class="co">## [15] S4Vectors_0.47.4            MetaboAnnotation_1.13.2    </span></span>
<span><span class="co">## [17] AnnotationHub_3.99.6        BiocFileCache_2.99.6       </span></span>
<span><span class="co">## [19] dbplyr_2.5.1                BiocGenerics_0.55.3        </span></span>
<span><span class="co">## [21] generics_0.1.4              BiocStyle_2.37.1           </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## loaded via a namespace (and not attached):</span></span>
<span><span class="co">##  [1] DBI_1.2.3               bitops_1.0-9            gridExtra_2.3          </span></span>
<span><span class="co">##  [4] httr2_1.2.1             rlang_1.1.6             magrittr_2.0.4         </span></span>
<span><span class="co">##  [7] clue_0.3-66             compiler_4.5.1          RSQLite_2.4.3          </span></span>
<span><span class="co">## [10] reshape2_1.4.4          png_0.1-8               systemfonts_1.3.1      </span></span>
<span><span class="co">## [13] vctrs_0.6.5             stringr_1.5.2           ProtGenerics_1.41.0    </span></span>
<span><span class="co">## [16] pkgconfig_2.0.3         crayon_1.5.3            fastmap_1.2.0          </span></span>
<span><span class="co">## [19] XVector_0.49.1          rmarkdown_2.30          ragg_1.5.0             </span></span>
<span><span class="co">## [22] purrr_1.1.0             bit_4.6.0               xfun_0.53              </span></span>
<span><span class="co">## [25] cachem_1.1.0            ChemmineR_3.61.2        jsonlite_2.0.0         </span></span>
<span><span class="co">## [28] blob_1.2.4              DelayedArray_0.35.3     parallel_4.5.1         </span></span>
<span><span class="co">## [31] cluster_2.1.8.1         R6_2.6.1                bslib_0.9.0            </span></span>
<span><span class="co">## [34] stringi_1.8.7           RColorBrewer_1.1-3      jquerylib_0.1.4        </span></span>
<span><span class="co">## [37] Rcpp_1.1.0              bookdown_0.45           knitr_1.50             </span></span>
<span><span class="co">## [40] base64enc_0.1-3         BiocBaseUtils_1.11.2    igraph_2.2.0           </span></span>
<span><span class="co">## [43] Matrix_1.7-4            tidyselect_1.2.1        abind_1.4-8            </span></span>
<span><span class="co">## [46] yaml_2.3.10             codetools_0.2-20        curl_7.0.0             </span></span>
<span><span class="co">## [49] plyr_1.8.9              lattice_0.22-7          tibble_3.3.0           </span></span>
<span><span class="co">## [52] withr_3.0.2             KEGGREST_1.49.2         S7_0.2.0               </span></span>
<span><span class="co">## [55] evaluate_1.0.5          desc_1.4.3              xml2_1.4.0             </span></span>
<span><span class="co">## [58] Biostrings_2.77.2       pillar_1.11.1           BiocManager_1.30.26    </span></span>
<span><span class="co">## [61] filelock_1.0.3          DT_0.34.0               ncdf4_1.24             </span></span>
<span><span class="co">## [64] RCurl_1.98-1.17         BiocVersion_3.22.0      ggplot2_4.0.0          </span></span>
<span><span class="co">## [67] scales_1.4.0            glue_1.8.0              lazyeval_0.2.2         </span></span>
<span><span class="co">## [70] tools_4.5.1             mzR_2.43.3              fs_1.6.6               </span></span>
<span><span class="co">## [73] grid_4.5.1              tidyr_1.3.1             MsCoreUtils_1.21.0     </span></span>
<span><span class="co">## [76] AnnotationDbi_1.71.1    cli_3.6.5               rappdirs_0.3.3         </span></span>
<span><span class="co">## [79] textshaping_1.0.4       rsvg_2.7.0              S4Arrays_1.9.1         </span></span>
<span><span class="co">## [82] dplyr_1.1.4             AnnotationFilter_1.33.0 gtable_0.3.6           </span></span>
<span><span class="co">## [85] sass_0.4.10             digest_0.6.37           SparseArray_1.9.1      </span></span>
<span><span class="co">## [88] rjson_0.2.23            htmlwidgets_1.6.4       farver_2.1.2           </span></span>
<span><span class="co">## [91] memoise_2.0.1           htmltools_0.5.8.1       pkgdown_2.1.3.9000     </span></span>
<span><span class="co">## [94] lifecycle_1.0.4         httr_1.4.7              CompoundDb_1.13.0      </span></span>
<span><span class="co">## [97] bit64_4.6.0-1           MASS_7.3-65</span></span></code></pre>
</div>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-rainer_modular_2022" class="csl-entry">
Rainer, Johannes, Andrea Vicini, Liesa Salzer, et al. 2022. <span>“A
<span>Modular</span> and <span>Expandable</span> <span>Ecosystem</span>
for <span>Metabolomics</span> <span>Data</span> <span>Annotation</span>
in <span>R</span>.”</span> <em>Metabolites</em> 12 (2): 173. <a href="https://doi.org/10.3390/metabo12020173" class="external-link">https://doi.org/10.3390/metabo12020173</a>.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Michael Witting, Johannes Rainer, Andrea Vicini, Carolin Huber, Philippine Louail.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.9000.</p>
</div>

    </footer>
</div>





  </body>
</html>
